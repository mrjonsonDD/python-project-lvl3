define(["PTS/webpush","OK/logger","OK/utils/utils","OK/uuid","OK/utils/vanilla"],(function(e,n,t,r,i){"use strict";var o="webpush-device-id",s="webpush-endpoint",u="DEFAULT",a="DENIED",c="GRANTED",l="SUBSCRIBED",f="UNSUBSCRIBED",p=null,d=!1,b=null;function h(){return"PushManager"in window&&"serviceWorker"in navigator&&window.Notification&&"localStorage"in window}function g(){return h()&&d}function w(e){return e=e||"unknown",I("Unsubscribe from notifications"),h()?y().then((function(t){return null!==t&&t.unsubscribe().then(I),"messages"!==e&&A(!1),n.success("webpush."+e+".unsubscribe"),k(),N(f,t,e,!0)}),(function(t){throw n.error("webpush."+e+".unsubscribe"),I(t),t})):Promise.reject("Push API is not supported")}function v(){return Notification?"denied"===Notification.permission?Promise.resolve(a):"default"===Notification.permission?Promise.resolve(u):y().then((function(e){return e?l:c})):Promise.resolve(a)}function S(){return I("Register service worker"),navigator.serviceWorker.register(swPath).then((function(e){if(e.installing?I("Service worker installing. scope = "+e.scope):e.waiting?I("Service worker installed"):e.active&&I("Service worker active"),!e.showNotification)throw n.error("webpush.support.showNotifications"),new Error("Notifications aren't supported on service workers.");if("denied"===Notification.permission)throw n.error("webpush.denied"),new Error("The user has blocked notifications.");if(!("PushManager"in window))throw n.error("webpush.support.pushManager"),new Error("Push messaging isn't supported");return navigator.serviceWorker.ready}))}function m(e){return I("Subscribe to notifications"),e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t.urlBase64ToUint8Array(p)})}function y(){var e=navigator.serviceWorker.getRegistration();return e?e.then((function(e){return e&&e.pushManager?e.pushManager.getSubscription():null})):Promise.resolve()}function N(e,n,t,r){I("Sync subscription");var o={status:e,place:t||"unknown",userAction:r};return n&&(o.subscription={deviceId:T(),endpoint:n.endpoint,auth:P(n,"auth"),p256dh:P(n,"p256dh")}),i.ajax({method:"POST",url:"/web-api/webpush/sync",headers:{"Content-Type":"application/json"},data:JSON.stringify(o)}).then((function(){var t;return n&&(t=n.endpoint,U(s,t)),e}))}function k(){D(s)}function A(e){U("notification_enabled_messenger",e?"1":"0")}function P(e,n){return btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey(n))))}function T(){var e=E(o);return e||(e=r.generate(),U(o,e)),e}function E(e,t){if(!localStorage)return null;try{return localStorage.getItem(e)}catch(e){return n.error("webpush.localStorage-get-"+(e.name||""+e)),t}}function U(e,t){if(localStorage)try{localStorage.setItem(e,t)}catch(e){n.error("webpush.localStorage-set-"+(e.name||""+e))}}function D(e){if(localStorage)try{localStorage.removeItem(e)}catch(e){n.error("webpush.localStorage-remove-"+(e.name||""+e))}}function I(){if(OK.fn.isDebug())if(arguments[0]instanceof Error)console.error.apply(console,arguments);else{var e=Array.prototype.slice.apply(arguments);e.unshift("[webpush]"),console.log.apply(console,e)}}return{STATUS_DEFAULT:u,STATUS_GRANTED:c,STATUS_DENIED:a,STATUS_SUBSCRIBED:l,STATUS_UNSUBSCRIBED:f,isSupported:h,isEnabled:g,activate:function(e){if(h()){d="true"===e.getAttribute("data-service-worker-is-enabled"),p=e.getAttribute("data-application-server-key"),b=e.getAttribute("data-server-status");var t="true"===e.getAttribute("data-message-notifications-enabled");if("true"===e.getAttribute("data-extended-settings-enabled")&&b===l&&A(t),D("webpush-activated"),!d)return I("Service worker is disabled"),void w().catch(I);v().then((function(e){return e===l?(I("Subscription is active"),y().then((function(e){b===l&&E(s)===e.endpoint||(I("Subscription has been changed"),n.success("webpush.subscription-changed"),N(l,e))}))):e!==c?(I("Permission has been revoked"),k(),A(!1),n.success("webpush.subscription-revoked"),b!==e?N(e):void 0):void(b!==e&&N(e))}),I)}},deactivate:function(){},subscribe:function(t){return t=t||"unknown",g()?v().then((function(r){if(r===a)throw new Error("User revoked permissions");return r===l?r:function(){if(Notification){if("default"===Notification.permission)return new Promise((function(e,t){Notification.requestPermission((function(r){"granted"===r?(n.success("webpush.request.granted"),e(c)):(n.success("webpush.request.denied"),t(a))}))}));if("granted"===Notification.permission)return Promise.resolve(c)}return Promise.reject(a)}().then(S).then(m).then((function(r){return"messages"!==t&&(A(!0),function(){if(!Notification)return;var n=e["notification.enabled.title"],t=e["notification.enabled.body"],r=OK.cnst.staticUrl+"res/i/html5_notif_icon.png";new Notification(n,{body:t,icon:r,tag:"messenger-enabled"})}()),n.success("webpush."+t+".subscribe"),N(l,r,t,!0)}),(function(){n.error("webpush."+t+".subscribe")}))})):Promise.reject("Module is disabled")},unsubscribe:w,getStatus:v}}));
//# sourceMappingURL=/res/source-maps/js/app/WebPush.js.map