define("OK/DiscussionManager",["jquery"],(function(e){var t={};return{add:function(e){var n=e.getId();if(e||n){t[n]||(t[n]=[]);for(var i=0;i<t[n].length;i++)if(t[n][i]==e)return;t[n].push(e)}},remove:function(e){var n=e.getId();if(e||n){var i=t[n].indexOf(e);i>-1&&t[n].splice(i,1)}},processUpdate:function(i){if("news"===i["tlb.act"]&&"newsFetch"===i.refId){var s=i.respCO,o=i.respNK;s&&e.each(s,(function(i,s){var o=t[i],r=s.dNCC;r>0?n(o,r):s.dntfCs&&n(o,500);for(var a=0;o&&a<o.length;a++)s.dntfECs&&e.each(s.dntfECs,(function(){o[a].updateComment(this.cId),OK.logging.logger.success("discussions.processUpdate","edit")})),s.dntfRCs&&e.each(s.dntfRCs,(function(){o[a].updateComment(this.cId),o[a].updateCount(-1),OK.logging.logger.success("discussions.processUpdate","remove")}))})),o&&e.each(o,(function(n,i){var s=t[n];s&&e.each(s,(function(){var t=this;e.each(i,(function(){var e=t.list.findComment(this.cId);e&&e.updateKlass()}))}))}))}},deleteComment:function(n,i,s){var o=t[n];o&&e.each(o,(function(){this.deleteComment(i,s)}))},restoreComment:function(n){var i=t[n];i&&e.each(i,(function(){this.restoreComment()}))},markAsRead:function(n){var i=t[n];i&&e.each(i,(function(){this.markAsRead()}))},forEachOpened:function(n,i,s){var o=t[i+"_"+n];o&&s&&e.each(o,(function(){s.call(this)}))}};function n(e,t){var n=e?e.length:0;if(!(n<1)){var i=e[0].refresh(t);if(i)for(var s=0;s<n;s++)e[s].processNewComments(i)}}})),define("OK/discussions/ScrollController",["jquery","OK/utils/throttle","OK/utils/utils"],(function(e,t,n){function i(e){this.element.scrollTop=this.element.scrollTop+e}var s=function(t,n,s){t=OK.util.extend({stickyContainer:e()},t),this.element=t.scrollingContainer,this.$element=e(this.element),this.loaderId=n,this.stickyContainer=t.stickyContainer,this.scrollingFn=s||i};return s.prototype={getLoader:function(){return OK.hookModel.getHookById(this.loaderId)},hasMore:function(){return null!=this.getLoader()&&this.getLoader().hasMore()},hasLess:function(){return null!=this.getLoader()&&this.getLoader().hasLess()},scroll:function(e,t){(t||this.scrollingFn).call(this,e)},scrollToBottom:function(e,t){if(e)this.scroll(e.getBoundingClientRect().bottom-this.visibleBottomOfContainer(this),t);else{var n=this.element;n&&this.scroll(n.scrollHeight,t)}},scrollToTop:function(e){var t=this.element;t&&(e=e||i,this.scroll(-t.scrollTop,e))},scrollToBottomFancy:function(e){var t=this.element;t&&this.scroll(t.scrollHeight,e)},scrollToTopOf:function(e){var t=this.element;if(!this.isVisible(e)&&t){var n=t.getBoundingClientRect(),i=e.getBoundingClientRect();this.scroll(Math.max(i.top-n.top,0)),this.trigger()}},hasScroll:function(){var e=this.element;if(e)return e.scrollHeight>e.offsetHeight},isScrolledToBottom:function(e){var t=this.element;if(t)return e=e||0,t.scrollTop+e>=t.scrollHeight-t.offsetHeight},getScrollTop:function(){return this.element&&this.element.scrollTop},setScrollTop:function(e){var t=this.element;t&&(t.scrollTop=e)},scrollTo:function(e,t){t=t||0;var n=this.element;n&&this.scroll(e.getBoundingClientRect().bottom-n.getBoundingClientRect().top+t)},scrollToCenter:function(e,t){t=t||i;var n=this.element;if(n){var s=n.getBoundingClientRect(),o=e.getBoundingClientRect(),r=s.bottom-s.top,a=s.top+r/2,l=o.bottom-o.top,c=o.top+l/2;l>r?this.scroll(o.top-a+r/3,t):this.scroll(c-a,t)}},isVisible:function(e){var t=this.element;if(!e||!t)return!1;var n=t.getBoundingClientRect(),i=e.getBoundingClientRect();return i.top>=n.top&&i.bottom<=this.visibleBottomOfContainer(this)},isVisibleBottomOf:function(e){return Math.abs(e.getBoundingClientRect().bottom-this.visibleBottomOfContainer(this))<4},isVisibleBottomOfElFromTop:function(e){var t=this.element;if(t){var n=e.getBoundingClientRect(),i=t.getBoundingClientRect(),s=Math.min(n.top-i.top,0);return s>=0||Math.abs(s)<=e.offsetHeight}},loadLast:function(){var e=this;return this.getLoader().loadLast().done((function(){e.scrollToBottom()}))},loadMore:function(){var e=this;return this.getLoader().loadMore().done((function(){e.scrollToBottom()}))},load:function(e){return this.getLoader()?this.getLoader().loadByUrl(e):n.ajax({url:e})},trigger:function(){this.$element.trigger("scroll")},addListener:function(e,t){return t?this.$element.on("scroll."+t,e):this.$element.on("scroll",e),this},removeListener:function(e){return this.$element.off("scroll",e),this},removeListeners:function(e){this.$element.off("scroll."+e)},makeVisible:function(e){var t=this.element;if(!this.isVisible(e)&&t){var n=t.getBoundingClientRect(),i=e.getBoundingClientRect(),s=Math.min(i.top-n.top,0)+Math.max(i.bottom-this.visibleBottomOfContainer(this),0);this.scroll(s)}},isScrollable:function(){var e=this.element;if(e)return e.scrollHeight>e.clientHeight},visibleBottomOfContainer:function(e){var t=e.element;if(t)return t.getBoundingClientRect().bottom-e.stickyContainer.height()},scrollTop:function(e){var t=this.element;t&&(t.scrollTop=e)}},s})),define("OK/textarea",["jquery"],(function(e){var t,n={className:"autosizejs",append:"",callback:!1,onBeforeResize:e.noop,resizeDelay:10},i=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],s=e('<textarea tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>').data("autosize",!0)[0],o=e('<div tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>').data("autosize",!0);return s.style.lineHeight="99px","99px"===e(s).css("lineHeight")&&i.push("lineHeight"),s.style.lineHeight="",o[0].style.lineHeight="99px","99px"===o.css("lineHeight")&&i.push("lineHeight"),o[0].style.lineHeight="",e.fn.autosize=function(r){var a=0;try{return this.length?(r=e.extend({},n,r||{}),a=1,s&&s.parentNode!==document.body&&(e(document.body).append(s),e(document.body).append(o)),a=2,this.each((function(){var n,l,c,u=this,h=e(u),d=0,f=e.isFunction(r.callback),m={height:u.style.height,overflow:u.style.overflow,overflowY:u.style.overflowY,wordWrap:u.style.wordWrap,resize:u.style.resize},g=h.width();function p(){var t,n;a=8,"getComputedStyle"in window?(t=window.getComputedStyle(u),n=u.getBoundingClientRect().width,a=9,e.each(["paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"],(function(e,i){n-=parseInt(t[i],10)})),a=10,s.style.width=o[0].style.width=n+"px"):(a=11,s.style.width=o[0].style.width=Math.max(h.width(),0)+"px")}function v(){a=19;var c,m,g,v="true"===u.contentEditable;a=20,t!==u?(!function(){var l={};if(a=12,t=u,s.className=r.className,n=parseInt(h.css("maxHeight"),10),a=13,e.each(i,(function(e,t){l[t]=h.css(t)})),a=14,e(s).css(l),o.css(l),a=15,p(),window.chrome){a=16;var c=u.style.width;a=17,u.style.width="0px",a=18,u.offsetWidth,u.style.width=c}}(),a=21):(p(),a=22),m=parseInt(u.style.height,10),a=23,v?(o.html(h.html()+r.append),a=24,g=o[0],a=25):(s.value=u.value+r.append,a=26,g=s,a=27),g.style.overflowY=u.style.overflowY,a=28,g.scrollTop=0,a=29,g.scrollTop=9e4,c=g.scrollTop,a=30,n&&c>n?(u.style.overflowY="scroll",a=31,c=n,a=32):(u.style.overflowY="hidden",a=33,c<l&&(c=l)),a=34,a=35,m!==(c+=d)&&(r.onBeforeResize.call(u,c),a=36,u.style.height=c+"px",a=37,f&&(r.callback.call(u,u),a=38))}function C(){a=39,clearTimeout(c),a=40,c=setTimeout((function(){a=41;var e=h.width();a=42,e!==g&&(g=e,a=43,v())}),parseInt(r.resizeDelay,10))}a=3,h.data("autosize")||(h.data("autosize",!0),a=4,"border-box"!==h.css("box-sizing")&&"border-box"!==h.css("-moz-box-sizing")&&"border-box"!==h.css("-webkit-box-sizing")||(d=h.outerHeight()-h.height()),a=5,l=Math.max(parseInt(h.css("minHeight"),10)-d||0,h.height()),a=6,h.css({overflow:"hidden",overflowY:"hidden",wordWrap:"break-word",resize:"none"===h.css("resize")||"vertical"===h.css("resize")?"none":"horizontal"}),a=7,a=48,h.on("input.autosize",v),!1!==r.resizeDelay&&(a=49,e(window).on("resize.autosize",C)),h.on("autosize.resize",v),a=50,h.on("autosize.resizeIncludeStyle",(function(){a=51,t=null,a=52,v()})),h.on("autosize.destroy",(function(){a=53,t=null,a=54,clearTimeout(c),a=55,e(window).off("resize",C),a=56,h.off("autosize").off(".autosize").css(m).removeData("autosize")})),a=57,v())}))):this}catch(e){OK.logging.logger.success("messagesLayer","e.autosize_"+a)}},e.fn.persistant=function(t){var n="localStorage"in window&&null!==window.localStorage;if(!this.length||!n)return e(this);var i=e("<div/>"),s={idKey:"data-id",afterInit:e.noop,valueGetAdapter:function(e){return e?this.html():this.val()},valueSetAdapter:function(e,t){e?this.html(i.text(t).html().replace(/\n/g,"<br>")):this.val(t)}};return t=e.extend({},s,t||{}),this.each((function(){var n,i=e(this),s="true"===this.contentEditable,o=t.valueGetAdapter.call(i,s),r=i.attr(t.idKey)||i.attr("id"),a=r?localStorage.getItem(r):null;o||(a&&t.valueSetAdapter.call(i,s,a),t.afterInit.call(this,a)),i.on("reset.persistant",(function(){localStorage.removeItem(r)})),i.on("textchange",(function(){n&&clearTimeout(n),n=setTimeout((function(){var e=t.valueGetAdapter.call(i,s);0===e.length||/^[<br>\s\t\n\r]+$/.test(e)?localStorage.removeItem(r):r&&e&&localStorage.setItem(r,e)}),200)}))}))},{activate:function(t){e(t).autosize()}}})),define("OK/discussions/NewCommentsLabel",["jquery"],(function(e){var t="click.label",n=function(t,n,i){this.discussion=n,this.form=i,this.element=t,this.$element=e(t),this.icon=e(".tico_img",this.element),this.text=e(".text",this.element),this.newCommentsMessage=null,this.comentAddedMessage=null,this.t=0};function i(e){e.removeClass("__hidden").addClass("__active")}return n.prototype={showAsNew:function(e){return this.newCommentsMessage=this.text.data("textnew"),this.refresh(e),this},show:function(e){var t=this;return this.comentAddedMessage=this.text.data("text"),this.refresh(e),this.t=setTimeout((function(){clearTimeout(t.t),t.refresh(e)}),4e3),this},refresh:function(e){var n=this;if(e&&this.$element.off(t).one(t,(function(){n.hide().discussion.showLatest(e)})),this.comentAddedMessage||this.newCommentsMessage){var s=function(){n.discussion.scrollController.hasMore()||(n.hide(),n.discussion.scrollController.removeListener(s))};this.discussion.scrollController.addListener(s)}this.comentAddedMessage?(this.text.html(this.comentAddedMessage),this.icon.removeClass("ic_arrow-d-w").addClass("ic_ok-w"),i(this.$element),this.comentAddedMessage=null):this.newCommentsMessage?(this.text.html(this.newCommentsMessage),this.icon.removeClass("ic_ok-w").addClass("ic_arrow-d-w"),i(this.$element),this.newCommentsMessage=null):this.hide()},hide:function(){return this.$element.addClass("__hidden").removeClass("__active"),this}},n})),define("OK/CurrentUserCfg",["require","exports","OK/GwtConfig"],(function(require,e,t){"use strict";var n;Object.defineProperty(e,"__esModule",{value:!0}),e.getInstance=e.CurrentUserCfg=void 0;var i=function(e){function t(){e.call(this,"CurrentUser")}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.setData=function(t){e.prototype.setData.call(this,t),this.urlPattern=null},t.prototype.getUrlPattern=function(){return this.urlPattern||(this.urlPattern=new RegExp(this.data["share.urlPattern"])),this.urlPattern},t.prototype.getUserId=function(){var e;return null===(e=this.data)||void 0===e?void 0:e.uid},t.prototype.getLanguage=function(){return this.data?this.data.lang:null},t.prototype.getBannerParameters=function(){return this.data&&this.data.bannerTargeting||null},t.prototype.getReplaceFeedBannerDelayMs=function(){return this.data.replaceFeedBannerDelayMs},t.getInstance=function(){return n||(n=new t),n},t}(t.GwtConfig);e.CurrentUserCfg=i,e.getInstance=i.getInstance})),define("OK/LinkDetector",["OK/CurrentUserCfg"],(function(e){function t(e,t){return{url:e[0],substr:t}}function n(){}return n.prototype.parse=function(e,t){var n=this;return new Promise((function(i){i(n.parseLinks(e,t))}))},n.prototype.parseLinks=function(n,i){var s=e.getInstance().getUrlPattern(),o=[];if(n&&0!==n.trim().length)for(var r=n.split(/\s+/),a=0;a<r.length;a++){var l=r[a],c=s.exec(l);if(null!=c&&c[0]===l)if(i){var u=n.charAt(n.length-1);" "!==u&&"\n"!==u&&" "!==u||o.push(t(c,l))}else o.push(t(c,l))}return o},n})),define("OK/discussions/LinkAttachController",["jquery","OK/utils/utils","OK/AttachPicker"],(function(e,t,n){var i={maxLinks:1,isSmall:!1};function s(t,s){if(this.settings=e.extend({},i,s),this.attachPickerId=t,this.queue={},this.processed={},this.removed={},this.linksProcessed=0,this.onAttachRemoved=o.bind(this),n.subscribe(t,"remove",this.onAttachRemoved),this.attachPickerId){var a=this,l=n.getFiles(this.attachPickerId);e.each(l,(function(e,t){var n=t.linkPreviewViewState;if(n){var i=n.sourceUrl;i&&r(a,i,t.type,t.id)}}))}}function o(t,n,i){var s=this;e.each(s.processed,(function(e,t){i=parseInt(i,10),t.type!==n||!isNaN(i)&&t.objectId!==i||("TOPIC"===n&&--s.linksProcessed,s.removed[e]=!0,delete s.processed[e])}))}function r(e,t,n,i){e.processed[t]={type:n,objectId:parseInt(i,10)},"TOPIC"===n&&++e.linksProcessed}return s.prototype.process=function(i,s){return function(i,s){var o=s.url,a=e.Deferred(),l=function(t,n){var i=n.url;return!t.queue[i]&&!function(t,n){var i=!1;if(t.processed[n])return!0;return e.each(t.processed,(function(e){i=i||0===e.indexOf(n)})),i}(t,i)&&!t.removed[i]}(i,s);if(a.notify(l),l){var c=t.ajax({url:"/dk?cmd=AttachLinkPreview",data:{linkUrl:o,sm:i.settings.isSmall?"on":"off"}});i.queue[o]=c,c.done((function(e){var t=!1;if(e&&(!(e=JSON.parse(e)).error&&i.queue[o]===this)){var s=e.id,l=e.type;if(l)(!("TOPIC"===l)||i.linksProcessed<i.settings.maxLinks)&&(OK.logging.logger.success("discussions.linkAttached",l),n.add(i.attachPickerId,[e],!0),r(i,o,l,s),t=!0)}a.resolve(t)})),c.always((function(){delete i.queue[o]})),c.fail((function(){OK.logging.logger.success("discussions.linkPreviewFailed"),a.reject(l)})),a.fail((function(){i.processed[o]={failed:!0}}))}return a}(this,s)},s.prototype.destroy=function(){n.unsubscribe(self.attachPickerId,"remove",this.onAttachRemoved)},s.prototype.reset=function(){this.queue={},this.processed={},this.removed={},this.linksProcessed=0},s.prototype.getAttachedLinks=function(){return Object.keys(this.processed)},s})),define("OK/StickerSuggester",["require","OK/utils/utils","OK/utils/dom","OK/logger"],(function(require){"use strict";var e=require("OK/utils/utils"),t=(require("OK/utils/dom"),require("OK/logger")),n="__active",i="StickerSuggester",s="propertychange.stSug change.stSug click.stSug keyup.stSug input.stSug paste.stSug",o=function(e,t){this.element=t,this.textarea=e.textarea,this.lastQuery="",this.isClearOnStickerSend="true"===t.getAttribute("data-clear-on-send");var n,i,o=this,r="true"===t.getAttribute("data-replace-images");o.textarea.on(s,(function(){clearTimeout(i),i=setTimeout((function(){document.activeElement===o.textarea.get(0)?(n=e.getValue(r).trim())?o.lastQuery!=n?o.sendRequest(n):o.lastContent&&o.show():o.clear(""):o.hide()}),100)}))};return o.prototype={sendRequest:function(n){var s=this;e.ajax({url:"/dk?cmd=SuggestStickers",data:{"st.q":n}}).fail((function(){t.error(i,"ajax")})).done((function(e){e?(s.lastQuery=n,s.lastContent=e,OK.hookModel.setHookContent("StickerSuggestCnt",e),s.show(),t.success(i,"show",n)):s.clear(n)}))},isEmojiMenuVisible:function(){var e=this.textarea.data("emojiarea"),t=e&&e.menu;return t&&t.visible},clear:function(e){this.hide(),this.lastQuery=e,this.lastContent=""},hide:function(){this.element.classList.remove(n)},show:function(){this.isEmojiMenuVisible()||this.element.classList.add(n)},destroy:function(){this.hide(),this.textarea.off(s)}},o})),define("OK/utils/scrollHelper",["jquery"],(function(e){return{scrollToVisible:function(t,n){var i=e(n),s=e(t),o=s.offset().top,r=s.scrollTop(),a=s.height(),l=o+a,c=i.height(),u=i.offset().top;u+c>l?s.scrollTop(r+u+c-o-a+5):u<o&&s.scrollTop(r+u-o-5)},scrollInLoadMoreDataPosition:function(t){var n=e(t);return t.scrollHeight-n.scrollTop()-n.height()<=200},isScrollingVisible:function(e){var t=e.offsetHeight||0;return(e.scrollHeight||0)>t},scrollIntoOKViewport:function(e){var t=e.getBoundingClientRect().top+document.scrollingElement.scrollTop,n=document.getElementById("topPanel");n&&(t-=n.offsetHeight),document.scrollingElement.scrollTo(0,t)}}})),define("OK/suggest/suggestImpl",["jquery","OK/utils/scrollHelper"],(function(e,t){function n(e,t,n){return e?t&&n&&t.type===n.type&&t.query===n.query:t===n}return function(i,s,o){var r=(s=e.extend(s,e.extend({selectOnReload:!1,correctSelection:!0,minSearchQueryLength:0,getMaxItemsInSuggest:function(){return 5},getMaxSelectedFriends:function(){return 5},getMarkFriendDisabledMsg:function(){return""},getSearchQuery:function(){return""},onItemsChanged:function(){},onItemClicked:function(e){},onSelectedItemChanged:function(e){},onLoadingChanged:function(e){},onSearchProgressChanged:function(e){},onSearchInputChanged:function(){}},s))).elementId,a="mm_"+r,l="mo_"+r,c="mc_"+r,u=s.selectOnReload,h=s.correctSelection,d=s.customCls||"",f=s.suggestElId||r,m=s.messageElId||r+"_msg",g=s.itemsElId||r+"_itms",p=s.loadingElId||r+"_loading";function v(e){return r+"_"+e}function C(t){return e(document.getElementById(v(t)))}var y,b,k,x,_,S,w,O,T,I=!0,E=s.getMaxItemsInSuggest()<=0,M=!1,L=[],K=[],A=-1,R=!1;function H(){if(T)return T;if((T=e("#"+f)).length>0){if(E){var n,i=function(){I&&!k&&w&&t.scrollInLoadMoreDataPosition(T[0])&&Z(S)};T.scroll((function(){n&&clearTimeout(n),n=setTimeout(i,300)}))}}else T=null;return T}function j(){if(E&&I&&!k&&w){var e=H();e&&!t.isScrollingVisible(e[0])&&Z(S)}}function P(t){var n="",o=0;L=[];for(var r=0,a=0;a<t.length;a++){var l=t[a],c=i.getItemById(l);if(c){if(!E&&(K[l]||r++,r>s.getMaxItemsInSuggest()))break;var u=F(l,o++,c),h=document.createElement("div");h.appendChild(u),n+=h.innerHTML,L.push(l)}}if(E){var d=document.createElement("div");d.appendChild(D()),n+=d.innerHTML}var f=e("#"+g);s.mention&&f.html()===n||f.html(n)}function B(t,n){var o;H(),w=n;var r,a=L.length,l=e("#"+g),c=function(){for(var e=0,t=0;t<L.length;t++)K[L[t]]||e++;return e}();E&&(r=e("#"+p));for(var u=0;u<t.length;u++){var h=t[u],d=i.getItemById(h);if(d){if(!E&&(K[h]||c++,c>s.getMaxItemsInSuggest()))break;var f=F(h,a++,d);E&&r&&(r.parent().remove(),r=null),l.append(f),L.push(h),o=!0}}E&&o&&l.append(D()),Q(null,!0),Y(),o&&s.onItemsChanged()}function D(){var e=document.createElement("li");return e.className="suggest_li "+(k?"":" invisible"),s.disableLoadingProgress||(e.innerHTML='<div id="'+p+'" class="loader-controls in-progress"><div class="link-show-more_loading"><span class="fetching-hor">***</span></div></div>'),e}function F(e,t,n){n.visible=!K[e];var i=document.createElement("li");return i.className="suggest_li"+(n.visible?"":" invisible"),i.innerHTML=o.createItemElement(n),i.setAttribute("id",v(e)),i.setAttribute("onmousemove","OK.il.f(event,'"+a+"', "+t+");"),i.setAttribute("onmouseover","OK.il.f(event,'"+l+"', "+t+");"),i.setAttribute("onclick","OK.il.f(event,'"+c+"', "+t+");"),i}function N(e){return 0!==C(e).length&&(function(e,t){var n=C(e);if(0===n.length)return!1;n.toggleClass("invisible",!t)}(e,!K[e]),!0)}function q(e,t){var n=i.getItemById(e),s=C(e);o.setItemSelected(n,s,t)}function V(e){return K[L[e]]}function U(e){return!V(e)&&(t=L[e],!i.getItemById(t).disabled);var t}var z={id:a,handlerId:"h"+this.id,handle:function(e,t){y||(R=!1)}},W={id:l,handlerId:"h"+this.id,handle:function(e,t){y||b||0<=t&&t<L.length&&A!==t&&U(t)&&(R=!1,G(t))}},$={id:c,handlerId:"h"+this.id,handle:function(e,t){if(!y&&0<=t&&t<L.length&&U(t)){R=!1,G(t);for(var n,o=e.target;null!=o&&!o.getAttribute("id")&&!(n=o.getAttribute("data-action"));)o=o.parentNode;s.onItemClicked(i.getItemById(L[t]),n)}}};function Q(e,t){if(0!==L.length)if(h){if(u&&e&&-1!=e){for(var n=0;n<L.length;n++)if(e==L[n])return void(U(n)&&G(n))}else if(-1!==A){if(V(A)){for(var i=A+1;i<L.length;i++)if(U(i))return void G(i);for(var s=A-1;s>=0;s--)if(U(s))return void G(s);G(-1)}}else for(n=0;n<L.length;n++)if(U(n)){G(n);break}}else t||G(-1);else-1!==A&&G(-1)}function G(e){"string"==typeof e&&(e=+e);var t=A!==e;if(A>=0&&A<L.length){var n=L[A];if(n){if(!t)return void q(n,!y);q(n,!1)}}if(A=-1,e>=0&&e<L.length){var o=L[e];if(!o||!U(e))return;q(o,!y),A=e,s.onSelectedItemChanged(i.getItemById(o)),t&&Y()}}function Y(){if(E&&R){var e;if(A>=0&&A<L.length)e=A;else{if(-1!=A)return;e=0}var n=L[e];if(n){var i=C(n);if(i.length>0){var s=H();t.scrollToVisible(s[0],i[0])}}}}OK.il.ah(z),OK.il.ah(W),OK.il.ah($);var J=function(e,t){var i,o;O=e;var r=e.query;e.type&&(r={query:r,type:e.type});var a=e.itemIds,l=e.hasMore;if(n(e.type,r,S))B(t,l),o=2;else if(n(e.type,r,s.getSearchQuery())||!e.type&&r.toString()==s.getSearchQuery().toString()){o=function(e,t,n){var i=A>=0&&A<L.length?L[A]:-1;if(H(),S=e,w=n,L.length==t.length||!E&&L.length>=s.getMaxItemsInSuggest()&&t.length>=s.getMaxItemsInSuggest()){if(0===t.length&&0===L.length)return!1;var o,r,a={},l=0;for(o=0;o<t.length&&(a[t[o]]=!0,E||(K[t[o]]||l++,!(l>=s.getMaxItemsInSuggest())));o++);var c=0;for(o=0;o<L.length;o++){if(!a[L[o]]){r=!0;break}if(!E&&(K[L[o]]||c++,c>=s.getMaxItemsInSuggest()))break}if(!E&&(c!=l||c>=s.getMaxItemsInSuggest())&&(r=!0),o=null,!r)return!1}A=-1,R=!0;var u=L.length>0&&0===t.length;return P(t),u=u||L.length>0,Q(i,!1),Y(),u&&s.onItemsChanged(),u}(r,a,l)?3:4}else i=!0,o=5;te(!1,!0,r,o,e),i||j()},X=function(e,t){_=e,te(!1,!1,t,-1)};function Z(e){var t;te(!0,!0,e,1),e=e||s.getSearchQuery(),t=s.getMaxItemsInSuggest()>0?s.getMaxItemsInSuggest()+s.getMaxSelectedFriends():0,i.search(e,t,J,X)}function ee(){var e=S;S=null,Z(e)}function te(t,n,i,o,r){k!=t&&(k=t,ie(),function(){if(!E||s.disableLoadingProgress)return;var t=e("#"+p);if(0==t.length)return;if(t.toggleClass("invisible",!k),k)H()}(),s.onLoadingChanged(k,n,i,o,r))}function ne(t){x!=t&&(x=t,e("#"+m).html(x))}function ie(){var t=e("#"+f);t.toggleClass("__active",I),t.toggleClass("__disabled",y||k),t.toggleClass("__message",M)}return{createHtml:function(){return'<div id="'+f+'" class="suggest'+(I?" __active":"")+(E?" __scroll":"")+(y||k?" __disabled":"")+(d?" "+d:"")+(M?" __message":"")+'"><div id="'+m+'" class="suggest_tx">'+(x||"")+'</div><ul id="'+g+'" class="suggest_ul"></ul></div>'},resetSelection:function(){var e=H();if(e){e.scrollTop(0);for(var t=0;t<L.length;t++)if(U(t)){G(t);break}}},isVisible:function(){return!!I},setVisible:function(e){!function(e){I!=e&&(I=e,ie())}(e)},setDisabled:function(e){!function(e){y!=e&&(y=e,ie())}(e)},setMouseOverDisabled:function(e){b!=e&&(b=e)},isMessageVisible:function(){return!!M},setMessageVisible:function(e){!function(e){M!=e&&(M=e,ie())}(e)},setMessage:function(e){ne(e)},search:function(e){Z(e||s.getSearchQuery())},isSearchDisabled:function(){return!!_},getDisplayQuery:function(){return S},hasVisibleItems:function(){for(var e=0;e<L.length;e++)if(!K[L[e]])return!0;return!1},hasHiddenItems:function(){for(var e=0;e<L.length;e++)if(K[L[e]])return!0;return!1},setHiddenItemId:function(e,t){t!=K[e]&&(K[e]=t,N(e)&&(E?(Q(),s.onItemsChanged(),t&&j()):ee()))},resetHiddenItemIds:function(e){var t,n=K;K=e=e||{};for(var i=0;i<L.length;i++){var o=L[i];(K[o]&&!n[o]||!K[o]&&n[o])&&N(o)&&(t=!0)}t&&(E?(Q(),s.onItemsChanged(),j()):ee())},resetItems:function(e,t){P(e||L),_selectedItemId=-1,void 0!==t&&(S=t)},getItemElId:v,selectPrevious:function(){if(0!==L.length&&-1!==A)for(var e=A-1;e>=0;e--)if(U(e)){R=!0,G(e);break}},selectNext:function(){if(0!==L.length)for(var e=A+1;e<L.length;e++)if(U(e)){R=!0,G(e);break}},selectItemById:function(e){for(var t=0;t<L.length;t++)if(L[t]==e){U(t)&&(R=!0,G(t));break}},getSelectedItem:function(){return 0<=A&&A<L.length?i.getItemById(L[A]):null},getSearchEntry:function(e){return e?i.getSearchEntry(e):O},SEARCH_RESULT_ERROR:-1,SEARCH_RESULT_LOADING:1,SEARCH_RESULT_APPEND_ITEMS:2,SEARCH_RESULT_SET_ITEMS:3,SEARCH_RESULT_SET_ITEMS_CACHED:4,SEARCH_RESULT_UNKNOWN:5,destroy:function(){OK.il.rh(z),OK.il.rh(W),OK.il.rh($),i.clearCaches(),s=null}}}})),define("OK/suggest/searchEngines",["jquery","OK/utils/utils","OK/utils/vanilla"],(function(e,t,n){"use strict";function i(e,t,n,i){return a("/dk?cmd="+e,t,n,i)}function s(e){var t=e.address;e.distance&&(t.length>0?t+=" ("+e.distance+")":t=e.distance),e.latitude=parseFloat(e.latitude),e.longitude=parseFloat(e.longitude),e.text=n.encodeHtml(e.name),e.smallText=e.categoryName,e.smallText2=n.encodeHtml(t)}function o(e){for(var t=0;t<e.length;t++){var i=e[t];i.imageSrc=i.photo,i.text=n.encodeHtml(i.name),i.ui=""+i.id,i.ul=0+i.id,i.uf=n.encodeHtml(i.name),i.mkto=!0}}function r(e,t){(e.id=e.ui,e.imageSrc=OK.userCache.getLinkOnUserAvatar(e),e.text=e.uf,t)||(e.mkto||(e.disabled=!0))}function a(e,n,i,s){function o(e){return e&&e.type}function r(e){return o(e)?e.query:e}function a(e){var t=o(e);return t?e.query+t:e}function l(e,t){return"function"==typeof e?l(e(t),t):e}var c={},u={};var h={endpoint:e,dataType:n,search:function(i,s,d,f){c[a(i)]||(c[a(i)]={query:r(i),type:o(i),index:0,itemIds:[],hasMore:!0,requestId:""});var m=c[a(i)];if(!m.hasMore||s&&m.itemIds.length>=s)return d(m,[]),m;var g="search-d-"+(new Date).getTime();m.requestId=g;var p={"gwt.requested":window.pageCtx.gwtHash,refId:m.requestId};if(!1!==h.prepareRequest(i,m,p)){var v=l(n,m);return t.ajax({type:"POST",url:l(e,m),data:p,dataType:v,timeout:1e4}).done((function(e,t,n){var s=n.getResponseHeader("TKN");if(s&&OK.tkn.set(s),m.requestId===g&&0!==c.length){var o;"html"===v?o=OK.util.parseJSON(e):"json"===v&&(o=e);var r=h.processResponse(o,m);if(r){for(var a=[],l=0;l<r.length;l++){var p=r[l],C=p.id;m.itemIds.push(C),a.push(C),u[C]=p}d(m,a)}else f(!0,i)}else f(!1,i)})).fail((function(e,t,n){f(!1,i)})),m}},prepareRequest:i,processResponse:s,clearCaches:function(){c={},u={}},getItemById:function(e){return u[e]},getSearchEntry:function(e){return c[a(e)]}};return h}function l(e){var t={},n=a("/web-api/suggest/locations/profile","json",(function(t,n,i){i.q=n.query,e&&(i.cid=e.value)}),(function(e,n){n.hasMore=!1;for(var i=e||[],s=0;s<i.length;s++){var o=i[s];o.id=o.cityId,o.text=o.city,o.smallText=o.regions?o.regions+", "+o.country:o.country,o.city&&(t[o.city.trim().toLowerCase()]=o)}return i}));return n.locationByCityCache=t,n}function c(t){return i("FriendsSearch","html",(function(t,n,i){e.extend(i,{"d.sq":n.query,"d.o":n.index,"d.d":"d.in"})}),(function(e,n){if(!1===e.searchEnabled)return null;var i=e["jsp.cc"],s=e["jsp.stc"]||0;n.index=n.index+i,n.hasMore=n.index<s,n.totalCount=s;var o=[],a=e["jsp.sr"]||[],l=e["jsp.sl"]||[];if(l.length&&l.forEach((function(e){a[e.ui]=e})),t||OK.userCache.updateUserCache(a),l.length)l.forEach((function(e){r(e,t),o.push(e)}));else for(var c in a)if(Object.prototype.hasOwnProperty.call(a,c)){var u=a[c];r(u,t),o.push(u)}return o}))}var u,h=a("/web-api/suggest/hashtags/search","json",(function(e,t,n){n.query=t.query}),(function(e,t){t.hasMore=!1;for(var n=e||[],i=0;i<n.length;i++){var s=n[i];s.hashTag=!0,s.id="#"+s.text}return n})),d=i("FriendsSearch","html",(function(t,n,i){e.extend(i,{"d.sq":n.query,"d.o":n.index,"d.d":"d.in","d.wg":"on"})}),(function(e,t){if(!1===e.searchEnabled)return null;var n=e["jsp.cc"],i=e["jsp.stc"]||0;t.index=t.index+n,t.hasMore=t.index<i,t.totalCount=i;var s=[],o=e["jsp.sr"]||[],r=e["jsp.sl"]||[],a={};if(r.length)r.forEach((function(e){a[e.ui]=e}));else for(var l in o)if(Object.prototype.hasOwnProperty.call(o,l)){var c=o[l];c.group||(a[l]=c)}function u(e,t){if(e.id=e.ul,e.group){var n=e.photo;n&&(e.imageSrc=n)}else e.imageSrc=OK.userCache.getLinkOnUserAvatar(e);e.text=e.uf,e.mkto||(e.disabled=!0),t.push(e)}if(OK.userCache.updateUserCache(a),r.length)r.forEach((function(e){u(e,s)}));else for(l in o)Object.prototype.hasOwnProperty.call(o,l)&&u(o[l],s);return s}));return{createSearchEngine:i,createYandexSearchEngineEndpoint:function(e,t){var n={},i={},s={search:function(e,t,o,r){n[e]||(n[e]={query:e,index:0,itemIds:[],requestId:""});var a=n[e];if(a.itemIds.length)return o(a,[]),a;a.requestId="search-d-"+(new Date).getTime();var l={refId:a.requestId};return!1!==s.prepareRequest(e,a,l)?(require(["OK/YandexMapsApi"],(function(t){t.then((function(t){t.suggest(l.request,l.options).then((function(t){var n=s.processResponse(t,a);if(n){for(var l=[],c=0;c<n.length;c++){var u=n[c],h=u.id;a.itemIds.push(h),l.push(h),i[h]=u}o(a,l)}else r(!0,e)}),(function(){r(!0,e)}))}))})),a):void 0},prepareRequest:e,processResponse:t,clearCaches:function(){n={},i={}},getItemById:function(e){return i[e]},getSearchEntry:function(e){return n[e]}};return s},locationsSearchEngine:l(),createLocationsSearchEngine:l,friendsSearchEngine:c(),allFriendsSearchEngine:c(!0),prepareUsersForRenderer:function(e){for(var t=0;t<e.length;t++)r(e[t])},hashtagsEngine:h,mentionsEngine:d,postingFormEngine:(u=function(e){return"hash"===e.type?h:d},a((function(e){return u(e).endpoint}),(function(e){return u(e).dataType}),(function(e,t,n){return u(e).prepareRequest(e.query,t,n)}),(function(e,t){return u(t).processResponse(e,t)}))),conversationsSearchEngine:i("ConversationsSearch","html",(function(t,n,i){e.extend(i,{"st.query":n.query,"st.count":n.index}),n.forwardMarker&&e.extend(i,{"st.lastelem":n.forwardMarker})}),(function(e,t){var n=e["jsp.cc"];t.hasMore=e["jsp.hm"],t.index=t.index+n,t.forwardMarker=e["jsp.fwd"];for(var i=[],s=e["jsp.ch"],o=0;o<s.length;++o){var r=s[o];r.disabled=!1,r.mkto=!0,r.uf=r.text,r.ui=r.id,r.ul=r.id,i.push(r)}return i})),placesSearchEngine:i("PostingFormPlacesSearch","json",(function(e,t,n){n["d.sq"]=e.query,n["d.o"]=t.index,n["ps.pin"]=e.pin,e.coords&&(n["ps.lt"]=e.coords[0],n["ps.lng"]=e.coords[1])}),(function(e,t){if(!1===e.searchEnabled)return null;var n=e["jsp.scc"]||0,i=e["jsp.sr"]||[],o=Math.min(e["jsp.stc"]||0,200);t.index=t.index+n,t.hasMore=t.index<o,t.totalCount=o,t.realTotalCount=e["jsp.str"]||0;for(var r=0;r<i.length;r++)s(i[r]);return i})),preparePlaceForRenderer:s,groupsSearchEngine:i("SearchCrossPostingGroups","json",(function(e,t,n){n["d.sq"]=t.query,n["d.o"]=t.index}),(function(e,t){if(!1===e.searchEnabled)return null;var i=e["jsp.cc"]||0,s=e["jsp.stc"]||0;t.index=t.index+i,t.hasMore=t.index<s,t.totalCount=s;for(var o=e["jsp.sr"]||[],r=0;r<o.length;r++){var a=o[r];a.imageSrc=a.photo,a.text=n.encodeHtml(a.name)}return o})),userGroupsSearchEngine:a("/web-api/suggest/groups/portal","json",(function(e,t,n){n.q=t.query}),(function(e,t){t.hasMore=!1;for(var i=e||[],s=0;s<i.length;s++){var o=i[s];o.text=n.encodeHtml(o.name)}return i})),prepareAdvertSelectionForRenderer:o,advertCatalogSearchEngine:function(e){return i("AdvertCatalogsSearch","json",(function(t,n,i){i["d.sq"]=n.query,i["d.fwd"]=n.forwardMarker,i["d.gr"]=e}),(function(e,t){if(!1===e.searchEnabled)return null;t.totalCount=e["jsp.stc"]||0,t.hasMore=e["jsp.hm"],t.forwardMarker=e["jsp.fwd"];var n=e["jsp.sr"]||[];return o(n),n}))},commentMentionsEngine:function(e,t){return i("ParticipantsSearch","html",(function(n,i,s){s["st.query"]=i.query,s["st.did"]=e(),t&&(s["st.wg"]="on")}),(function(e,t){if(!1===e.searchEnabled)return null;var n=e["jsp.cc"],i=e["jsp.stc"]||0;t.index=t.index+n,t.hasMore=t.index<i,t.totalCount=i;var s=[],o=e["jsp.sr"]||{},r={};for(var a in o){if(Object.prototype.hasOwnProperty.call(o,a))(l=o[a]).group||(r[a]=l)}for(var a in OK.userCache.updateUserCache(r),o)if(Object.prototype.hasOwnProperty.call(o,a)){var l;if((l=o[a]).group){l.id=l.ui;var c=l.photo;c&&(l.imageSrc=c)}else l.id=a,l.imageSrc=OK.userCache.getLinkOnUserAvatar(l);l.text=l.uf,l.mkto||(l.disabled=!0),s.push(l)}return s}))}}})),define("OK/suggest/renderers",[],(function(){function e(e){return this.options=e,this}function t(e){return this.options=e,this}function n(e){return this.options=e,this}return e.prototype.createItemElement=function(e){return'<div class="ucard-mini'+(e.hashTag?" __hash-tag":"")+(e.selected?" __selected":"")+(e.disabled?" __na":"")+'">'+(e.imageSrc?'<img class="ucard-mini_img" src="'+e.imageSrc+'" alt="Image" width="32" height="32">':e.stub?'<div class="ucard-mini_img '+e.stub+'"></div>':"")+'<div class="ucard-mini_cnt"><div class="ucard-mini_cnt_i ellip">'+(e.text?e.text:"")+"</div>"+(e.smallText?'<div class="ucard-mini_info">'+e.smallText+"</div>":"")+"</div></div>"},e.prototype.setItemSelected=function(e,t,n){t.find(".ucard-mini").toggleClass("__selected",n)},t.prototype.createItemElement=function(e){return'<div class="ucard-mini'+(e.selected?" __selected":"")+(e.disabled?" __na":"")+'">'+e.image+'<div class="ucard-mini_cnt"><div class="ucard-mini_cnt_i ellip">'+(e.text?e.text:"")+"</div>"+(e.smallText?'<div class="ucard-mini_info">'+e.smallText+"</div>":"")+"</div></div>"},t.prototype.setItemSelected=function(e,t,n){t.find(".ucard-mini").toggleClass("__selected",n)},n.prototype.createItemElement=function(e){return'<div class="ucard-v __xxs __h'+(e.selected?" __selected":"")+(e.disabled?" __na":"")+'">'+(e.imageSrc?'<div class="section"><div class="photo"><img class="photo_img" src="'+e.imageSrc+'" alt="Image" width="32" height="32"></div></div>':"")+'<div class="caption"><div class="ellip">'+(e.text?e.text:"")+"</div>"+(e.smallText?'<div class="info ellip">'+e.smallText+"</div>":"")+"</div></div>"},n.prototype.setItemSelected=function(e,t,n){t.find(".ucard-v").toggleClass("__selected",n)},{MiniCard:e,UCard:n,ConversationCard:t}})),define("OK/postingForm/mentions",["jquery","OK/suggest/suggestImpl","OK/suggest/searchEngines","OK/suggest/renderers","OK/logger"],(function(e,t,n,i,s){var o="mediatopic.m",r="pform_name",a="__active",l="data-name",c=e("<span class='pform_name o'></span>").get(0),u=e("<span class='pform_name al' data-hash-tag='true'></span>").get(0),h=new RegExp("[W#$%!^&*()_+'']");function d(t){var n=1,i=3;function s(e){return e.nodeType==i}function o(e,t){return e.nodeType==n&&e.tagName.toUpperCase()==t}function r(t){return s(t)||function(e){return o(e,"BR")}(t)||function(t){if(o(t,"SPAN")){var n=e(t);if(!n.contents().is((function(){return!s(this)})))return"pform_name o"==t.className&&(n.removeAttr("style"),!0)}return!1}(t)}function a(t){return function(t){var n=o(t,"DIV");if(n){var i=e(t);i.removeAttr("style"),i.removeAttr("class")}return n}(t)&&!e(t).contents().is((function(){return!r(this)}))}for(;;){var l=t.contents().not((function(){return r(this)||a(this)}));if(0==l.length)break;l.filter((function(){return this.nodeType!=n})).remove().end().filter((function(){return this.nodeType==n})).replaceWith((function(){var t=e(this).contents();return"DIV"==this.tagName.toUpperCase()||"P"==this.tagName.toUpperCase()?t.filter((function(){return r(this)})).wrap("<div></div>").end():t}))}}function f(e){return e&&"true"===e.getAttribute("data-hash-tag")}function m(t,n,i){var s,o=/#[^\s#\\.]+/,r=t.selector.getRange(),a=r.startContainer,l=r.startOffset,c=!1;function h(e){for(;s<e.childNodes.length;){if(t.util.isText(e.childNodes[s]))return!0;s++}return!1}function d(e){for(var n;s<e.childNodes.length;){var i=e.childNodes[s];if(!t.util.isText(i))break;n?(n===a?c=!0:i===a&&(c=!0,a=n,l=n.nodeValue.length+l),n.nodeValue+=i.nodeValue,i.parentNode.removeChild(i),s--):n=i,s++}return n}n.find("span").filter((function(){return!this.className})).replaceWith((function(){return c=!0,a===this&&(a=this.firstChild),this.childNodes})),n.find("span").filter((function(){if(f(this)){var e=this.innerText,n=o.exec(e);if(!(n&&n[0].length===e.length))return!0;if(t.util.isText(this.nextSibling)&&this.nextSibling.nodeValue.length>0&&!/\s/.test(this.nextSibling.nodeValue[0]))return!0}return!1})).replaceWith((function(){return c=!0,a===this&&(a=this.firstChild),this.childNodes})),n.children().each((function(t,n){for(s=0;h(n);){var i=d(n);if(i){for(var r,f=a===i,m=i.nodeValue;m;){var g=o.exec(m);if(g&&g[0].length>0){r||(r=document.createElement("DIV"));var p=g[0],v=g.index;if(v>0){var C=document.createTextNode(m.substring(0,v));f&&(l<v?(a=C,f=!1,c=!0):l-=v),r.appendChild(C)}var y=e(u.cloneNode(!1));y.text(p),r.appendChild(y[0]),f&&(l<=p.length?(a=y[0].firstChild,f=!1,c=!0):l-=p.length),m=m.substring(v+p.length)}else{if(r){var b=document.createTextNode(m);f&&(a=b,f=!1,c=!0),r.appendChild(b)}m=!1}}if(r){for(;r.firstChild;)i.parentNode.insertBefore(r.firstChild,i),s++;i.parentNode.removeChild(i),s--}}}})),c&&((r=document.createRange()).setStart(a,l),t.selector.addRange(r))}return function(g){var p={bindStep:0,getDebugStep:function(){return bindStep},suggestCtx:{onItemClicked:e.noop,onLoadingChanged:e.noop,getMaxSelectedFriends:function(){return 1},onItemsChanged:e.noop,onSelectedItemChanged:e.noop,getMaxItemsInSuggest:function(){return 5},getMarkFriendDisabledMsg:function(){return p.markDisabledMsg},elementId:g||"_mPF",mention:!0,customCls:""},suggest:null,suggestElement:null,suggestElementVisible:!1,mentionsCharStart:3,mentionsFirstCharUpperCase:!0,cleanupOnPaste:!0,redesign:!1,customCls:"__mentions",searchTimer:!1,searchTimerDelay:0,scMenuWidth:"300px",useText:!1,util:function(){s.error("mt.e","util")},selector:function(){s.error("mt.e","selector")},init:function(s,o,r,a,l,c){if(bindStep=1,p.markDisabledMsg=s,p.util=o,p.selector=r,bindStep=2,!document.getElementById(p.suggestCtx.elementId)){bindStep=3;var u=i.MiniCard,h=new u;h.createItemElement=function(e){return e.group?e.smallText=e.gi:e.hashTag?e.smallText=e.count:e.smallText=e.disabled?p.markDisabledMsg:"",u.prototype.createItemElement(e)},bindStep=4;var d=l||(c?n.postingFormEngine:a?n.mentionsEngine:n.friendsSearchEngine);p.suggest=t(d,p.suggestCtx,h),bindStep=5;var f="sc-menu "+p.customCls;a&&(p.redesign=!0,p.searchTimerDelay=300,f+=" __redesign"),p.withHashTags=c,e(document.body).append('<div id="'+p.suggestCtx.elementId+'" class="'+f+'">'+p.suggest.createHtml()+'<div class="sc-menu_arw_w"><div class="sc-menu_arw"></div></div></div>'),bindStep=6,p.suggestElement=e("#"+p.suggestCtx.elementId).css({width:p.scMenuWidth}),p.suggestElementVisible=!0,bindStep=7}},destroy:function(){p.suggest&&p.suggest.destroy(),p.suggest=null,e("#"+p.suggestCtx.elementId).remove()},bind:function(t){var n,i=!1,g=e(t);bindStep=8;var v,C=g.parent().find(".pform_name-bg");if(bindStep=9,0===C.length&&(C=e('<span class="pform_name-bg"></span>')).insertBefore(g),bindStep=10,S(),bindStep=11,p.selector.supportsRange())return bindStep=12,p.util.isFireFox||g.on("focusout.mentions",(function(){v=p.selector.getRange()})),g.on("keydown.mentions",(function(e){13!==e.which&&9!==e.which&&27!==e.which&&38!==e.which&&40!==e.which||!p.suggestElementVisible||(e.preventDefault(),9===e.which&&e.stopPropagation(),27===e.which&&(e.stopPropagation(),S()))})).on("keyup.mentions",(function(n){var l,c,u;p.suggestCtx.onItemClicked=e.noop,p.suggestCtx.getSearchQuery=function(){var e=l||"";return c&&(e={query:e,type:c}),e},p.suggestCtx.onLoadingChanged=function(t){!t&&p.suggest.hasVisibleItems()&&function(t,n){var i;if(t){if(p.redesign){var r=g.offset().left,l=g.width(),c=10,u=300,h=r+l+2*(c+1)>t.left+u,d=e(window).scrollTop(),f=t.bottom+d;h?p.suggestElement.css({left:t.left-c,top:f}):p.suggestElement.css({left:r+l+2*c-u,top:f});var m=window.innerHeight,v=p.suggestElement.outerHeight(!0);f+v>m+d&&p.suggestElement.css({top:f-t.height-v})}else p.suggestElement.css({left:t.left-140,top:t.bottom+e(window).scrollTop()});p.suggestElement.removeClass("sc-menu__hidden"),p.suggestElementVisible=!0,i=C.parent().get(0).getBoundingClientRect(),C.css({top:t.top-i.top-2,left:t.left-i.left,width:t.width,height:t.height}),C.toggleClass(a,!0),38==n.which?p.suggest&&p.suggest.selectPrevious():40==n.which&&p.suggest&&p.suggest.selectNext(),s.success(o,"show_menu")}else S()}(u,n),p.suggest.hasVisibleItems()||S()};var d=p.selector.getRange(),v=p.util.getSelectedNode(d,d.startContainer,d.startOffset,!0);if(p.util.isSpace(n.which)&&p.util.isSpan(v.parentNode)&&e(v.parentNode).hasClass(r)&&!f(v.parentNode)&&v.parentNode.lastChild===v&&p.util.isText(v)&&v.nodeValue.length===d.startOffset&&(_(v.parentNode,d),n.preventDefault()),(l=b(v,d,n,i))&&(l.length>=(p.mentionsCharStart>0?p.mentionsCharStart:3)&&(!p.mentionsFirstCharUpperCase||p.mentionsFirstCharUpperCase&&l[0].toUpperCase()===l[0]&&!h.test(l[0]))||"@"===l[0]||"+"===l[0]||p.withHashTags&&"#"===l[0])){var w,O=k(v,d),T=!1;if(O)if(13===n.which||9===n.which)i=!1,x(O,d);else u=O.getBoundingClientRect(),s.success(o,"search"),p.withHashTags&&(c="#"===l[0]?"hash":"mention"),("@"===l[0]||"+"===l[0]||p.withHashTags&&"#"===l[0])&&(s.success(o,"trigger"),l=l.substr(1),i=p.redesign),w=c?{query:l,type:c}:l,p.searchTimer&&clearTimeout(p.searchTimer),!p.redesign||"@"===l[0]||"+"===l[0]||p.withHashTags&&"#"===l[0]||0==p.searchTimerDelay||p.suggestElementVisible?(p.searchTimer=!1,p.suggest.search(w)):p.searchTimer=setTimeout((function(){p.suggest.search(w)}),p.searchTimerDelay),T=!0,p.suggestCtx.onItemClicked=function(){p.util.isInEditor(O.startContainer)&&(x(O,d),S())}}(u&&p.suggest.hasVisibleItems()||S(),p.util.normalizeFont(),function(n,i){var s,o=!0;8===n.which&&p.util.isFireFox&&(s=p.selector.getFocusElement(i),e(s).hasClass(r)&&(e(s.childNodes).each((function(e,t){p.util.isText(t)&&t.nodeValue.length>0&&(o=!1)})),o&&0===t.innerHTML.indexOf(s.outerHTML)&&(e(s).replaceWith(document.createTextNode(String.fromCharCode(160))),g.focus())))}(n,d),p.withHashTags)&&(m(p,g),T&&(d=p.selector.getRange(),b(v=p.util.getSelectedNode(d,d.startContainer,d.startOffset,!0),d,n,i)&&(O=k(v,d))));y()})).on("paste.mentions",(function(){setTimeout((function(){p.cleanupOnPaste&&(p.util.cleanWordComments(g),d(g)),p.withHashTags&&m(p,g),y()}),50)})).on("click.mentions",(function(){g.focus(),y()})),bindStep=14,{unbind:function(){g.off(".mentions"),C.remove(),p.searchTimer&&clearTimeout(p.searchTimer),p.searchTimer=!1},getFocus:function(){return v},restoreFocus:function(){g.focus(),v&&p.selector.addRange(v)},hide:S,log:function(){g.find("span.pform_name").each((function(t,n){var i=e(this).attr(l);i&&this.innerHTML!==i&&s.success(o,"mention_changed")}))}};function y(){p.util.isFireFox&&(v=p.selector.getRange())}function b(t,i,s,o){if(27===s.which)return null;var r=i.startOffset;if(r<=0||!p.util.isText(t)||t.nodeValue.length<=0||!o&&p.util.isSpace(s.which))return null;var a=e(t).parents(".pform_name");if(!(0===a.length||p.withHashTags&&f(a[0])))return null;var l=t.nodeValue,c=l[r-1];if(!o&&p.util.isSpace(c))return null;if(o)for(n=r-1;n>=0&&!("+"===l[n]||"@"===l[n]||p.withHashTags&&"#"===l[n]);n-=1);else for(n=r-1;n>=0;n-=1)if(p.util.isSpace(l.charCodeAt(n))){n+=1;break}return n<0&&(n+=1),l.substring(n,r)}function k(e,t){var i;return p.util.isText(e)&&n>=0?((i=document.createRange()).setStart(e,n),i.setEnd(e,t.startOffset),i):null}function x(t,n){var i,s=p.suggest&&p.suggest.getSelectedItem();if(t&&s&&!s.disabled){document.getSelection().removeAllRanges(),document.getSelection().addRange(t),i=(s.hashTag?u:c).cloneNode(!1),t.surroundContents(i);var o=e(i);s.hashTag?o.text(s.id):(o.html(p.useText?s.text:s.un),o.attr(s.group?"data-group-id":"data-user-id",s.ul).attr(l,o.html())),_(i,n)}}function _(e,t){var n=f(e)?" ":String.fromCharCode(160),i=document.createTextNode(n);g.focus(),p.util.after(e,i),t.setStart(i,1),p.selector.addRange(t)}function S(){i=!1,p.suggestElement.css({left:0,top:-1e3}),p.suggestElementVisible=!1,p.suggest.resetSelection(),C.css({top:0,left:0,width:0,height:0}),C.removeClass(a)}s.success(o,"not_supported")}};return p}})),define("OK/scroll",[],(function(){function e(e,t,n,i){return(e/=i/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t}return{animateVScroll:function(t,n){var i=function(e){var t=Math.min(500,Math.max(300,3*Math.abs(e)));return Math.floor(t)}(n),s=e,o=Date.now(),r=t.scrollTop,a=r;this._animationId=o;var l=function(){if(this._animationId===o){var e=Math.min(Date.now()-o,i),c=Math.round(s(e,r,n,i));t.scrollTop+=c-a,a=c,e<i&&requestAnimationFrame(l)}}.bind(this);requestAnimationFrame(l)}}})),define("OK/discussions/CommentForm",["require","OK/textarea","jquery","OK/utils/vanilla","OK/discussions/NewCommentsLabel","OK/AttachPicker","OK/LinkDetector","OK/discussions/LinkAttachController","OK/emojiarea","OK/StickerSuggester","OK/postingForm/mentions","PTS/discussion.client","OK/suggest/searchEngines","OK/scroll"],(function(require,e,t,n,i,s,o,r,a,l,c,u,h,d){"use strict";var f={commentAreaContainer:t(),scrollingContainer:document.body,onStateChanged:t.noop,persistant:!0,collapsable:!0,cleanOnPaste:!1,isStickyForm:!0,typingListener:{onTypingStatusChanged:t.noop},parseLinks:!0,instantSending:!1,instantPaste:!1,sendOnCtrlEnter:!1,newLineOnCmdEnter:!1,collapseText:!0},m=["PHOTOUPLOADED","VIDEOUPLOADED","FILE"],g=t("html"),p=g.hasClass("gecko"),v="​",C=t(),y=!1,b=g.hasClass("chrome")||g.hasClass("mac-chrome"),k=g.hasClass("mac-saf");function x(e){p&&!y&&(y=!0,C=t(document.createTextNode(v)),e.textarea.append(C),e.container.toggleClass("__placeholder",e.isEmpty()))}function _(e){p&&y&&(y=!1,C=null,e.getValue().substr(0,1)===v&&e.setValue(e.getValue().substr(1)),e.container.toggleClass("__placeholder",e.isEmpty()))}function S(e){e.hasFocus=!1,e.typingStatusCheck&&(e.typingStatusCheck=clearInterval(e.typingStatusCheck)),e.textarea.off("click.cC keyup.linkParsing paste.linkParsing"),t(document).off("paste.imagePasting"),e.imagePastingHandlerAdded=!1}function w(e){require(["OK/AttachUploader"],(function(n){var i=t(".js-uploader-hook",e.discussion.element);e.options.parseLinks&&(e.onPasteUploader=i.data("uploader"),e.onPasteUploader||(e.onPasteUploader=new n,e.onPasteUploader.activate(i))),e.imagePastingHandlerAdded||(e.imagePastingHandlerAdded=!0,t(document).on("paste.imagePasting",(function(n){var i=n.clipboardData||n.originalEvent.clipboardData;if(i&&i.items){var s=i.items;t.each(s,(function(t,n){var i=n.getAsFile();if(i&&0===i.type.indexOf("image")){OK.logging.logger.success("discussions.imagePasted");var s=new Date,o=new File([i],"attached-picture"+s,{type:i.type,lastModifiedDate:s});e.onPasteUploader&&e.onPasteUploader.onFileSelect([o])}}))}})))}))}function O(e){var t=e.container&&e.container[0]&&e.container[0].closest(".comment-form_cnt");return t&&t.querySelector(".instant-comments")}function T(e){var t=O(e);if(t){var n=!e.replyMode;t.classList.toggle("__collapsed",!n)}}function I(e){var t=O(e);t&&t.classList.toggle("__collapsed",!0)}function E(e,n,s){var a=0;try{this.options=t.extend({},f,n.options,s||{}),a=1,this.textarea=e,a=2,this.form=this.textarea.closest("form"),a=3,this.container=this.textarea.closest(".js-comments_form"),a=4,this.cancelBtn=t(".comments_add-controls_cancel",this.container),a=5,this.official=t(".form-actions__official",this.container),a=6,this.attached=t(".attachedInput",this.container),a=7,this.officialContainer=t(".comments_add-controls_checkbox",this.container),a=8,this.userAvatar=t(".comments_author-avatar__user",this.container),a=9,this.groupAvatar=t(".comments_author-avatar__group",this.container),a=10,this.discussion=n,a=11,this.replyMode=!1,a=12,this.comment=null,a=13,this.replyCommentIdInput=t('[name="st.cId1"]',this.container),a=14;var c=t(".attachPicker",this.container);a=15,c&&c.length>0?(a=16,this.objectId=c.data("object-id")):(a=17,this.objectId=null),a=18,this.states={},a=19;var u=t(".tipDiscussion",this.container);u.size()>0&&(this.label=new i(u,n,this)),a=20,this.linkDetector=new o(e),a=21,this.linksController=new r(this.objectId),a=22,this.disabled=!1,a=23;var h=t(".js-st-suggest",this.container);a=24,h.size()>0&&(a=25,this.stickerSuggester=new l(this,h[0])),this.persistants=null}catch(e){OK.logging.logger.success("messagesLayer","e.commentForm_"+a)}}function M(e){e.options.mentionsEnabled&&OK.loader.use(["jQuery","OKCustomJs","OKTextarea"],(function(){var t,n=c("cfm_"+Date.now()),i=OK.editor.util,s=OK.editor.selector;i.isSafari=OK.util.isSafari(),i.isWebKit=OK.util.isWebkit(),n.mentionsCharStart=e.options.mentionsCharStart,n.useText=!0,e.options.participantsSearchEnabled&&(t=h.commentMentionsEngine((function(){return e.discussion.getId2()}),e.options.groupMentionsEnabled)),n.init(u.markFriendDisabled,i,s,!0,t),e.mentions=n.bind(e.textarea)}))}function L(e){var n=this;function i(){n.linksInProgress&&(n.linksInProgress=n.linksInProgress-1,0===n.linksInProgress&&n.changeState(E.states.progress,!1))}function s(e){e&&(n.changeState(E.states.progress,!0),n.linksInProgress=(n.linksInProgress||0)+1)}n.linkDetectionTimer&&clearTimeout(n.linkDetectionTimer);var o="paste"===e.type;function r(){n.linkDetector.parse(n.getValue(),!o).then((function(e){e.length>0&&OK.logging.logger.success("discussions.linksParsed",e.length,o),t.each(e,(function(e,t){OK.logging.logger.success("discussions.linkParsed"),n.linksController.process(e,t).progress(s).always(i)}))}))}o?setTimeout(r,10):n.linkDetectionTimer=setTimeout(r,400)}return E.states={initial:"__initial",active:"__active",disabled:"__disabled",error:"__error",notify:"__notify",cancelable:"__cancelable",invisible:"__invisible",progress:"__progress"},E.prototype={init:function(){var e=0,n=this,i=this.container,o=this.textarea,r=t(".js-comments_add-error",this.container),a=t(".form-actions_yes",i),l=t(".comments_add-controls_save",i);function c(){i.removeClass("__disabled"),a.removeAttr("disabled","disabled").removeClass("__disabled"),l.removeAttr("disabled","disabled").removeClass("__disabled"),n.disabled=!1}function u(){n.isInProgress=!0,n.posted=t.Deferred(),_(n);var e=o.data("emojiarea");e&&e.hideMenu();var s=n.isValid();return n.options.instantSending&&s?n.resetState():(i.addClass("__disabled"),a.attr("disabled","disabled").addClass("__disabled"),l.attr("disabled","disabled").addClass("__disabled"),n.disabled=!0),s}function h(e){c(),n.setCaretToEnd(),n.isValid()&&(n.changeState(E.states.error),e&&e.key&&r.html(e.key))}function d(e){38!==e.which||n.isValid()?27===e.keyCode&&(n.cancelReplyEditMode(),e.stopPropagation()):(n.discussion.list.editLast(),e.stopPropagation())}try{if(e=1,require(["OK/textCounter"],(function(){var e=n.textarea.attr("data-maxLength"),i=e||4096;t(".txt-counter",n.container).textCounter(o,{maxLength:i,valueGet:function(){return n.getValue(!0)}})})),e=2,n.initAutosize(),e=3,n.objectId){var f=s.get(n.objectId);f.on("update",n.onAttachUpdate.bind(n)),f.on("instantSendAttaches",n.instantSendAttaches.bind(n)),f.serializeAttachesCb=n.serializeAttaches.bind(n),f.sendUploadedAttachesCb=n.sendUploadedAttaches.bind(n)}e=4,n.options.persistant&&(n.persistants=o.persistant({afterInit:function(e){n.collapse()}})),e=5,n.form.submit((function(e,t){if(e.preventDefault(),n.beforeFormSubmit(),n.isValid()&&!n.disabled){if(n.options.checkAttachOnSubmit){var i=n.attached.val(),s=i&&""!==i?JSON.parse(n.attached.val()):[];if(s.length>0){for(var r=!1,a=0;a<s.length;a++){var l=s[a];m.indexOf(l.type)>-1&&l.id<0&&(r=!0)}if(r)return void(n.options.asyncUploadEnabled?(n.scheduleMessage(),function(){_(n);var e=o.data("emojiarea");e&&e.hideMenu(),n.resetState()}()):h())}}var d=n.serialize({});n.createRequest(d,u,h,c),OK.logging.logger.success("discussions.formSubmit",t||!1)}})),e=6,o.keypress((function(e){var t=e.keyCode||e.which,i=k&&(e.ctrlKey||e.altKey),s=13===t&&e.altKey,o=13===t&&!e.ctrlKey&&!e.metaKey,r=(13===t||10===t)&&(e.ctrlKey||e.metaKey),a=n.options.sendOnCtrlEnter?r:o,l=n.options.sendOnCtrlEnter?o:r,c=n.options.newLineOnCmdEnter&&!i&&(s||l);if(!a||e.altKey||e.shiftKey||(n.form.trigger("submit",[!0]),e.preventDefault()),c&&(e.preventDefault(),window.getSelection)){var u=window.getSelection(),h=u.getRangeAt(0),d=document.createElement("br"),f=this.childNodes.length,m=this.childNodes[f-1];if(f<2||m.nodeName&&"#text"==m.nodeName){var g=document.createElement("br");this.appendChild(g)}h.deleteContents(),h.insertNode(d),h.setStartAfter(d),h.setEndAfter(d),h.collapse(!1),u.removeAllRanges(),u.addRange(h)}n.changeState(E.states.active)})).keydown((function(e){var i=e.keyCode||e.which;(37===i||39===i)&&e.stopPropagation();var s=(13===i||10===i)&&e.metaKey;if(n.options.newLineOnCmdEnter&&b&&s){var o=jQuery.Event("keypress");o.keyCode=13,o.metaKey=!0,t(this).trigger(o)}})).focus((function(){if(n.hasFocus=!0,n.options.collapsable&&t(document).off("click.cF").on("click.cF",(function(){n.deactivate(!1)})),x(n),o.on("keydown.esc",d),n.options.instantPaste||o.one("blur",(function(){S(n)})),o.on("click.cC",(function(){n.changeState(E.states.active)})),n.changeState(E.states.active),i.on("click.cC",(function(e){e.stopPropagation()})),n.options.parseLinks&&o.on("keyup.linkParsing paste.linkParsing",L.bind(n)),n.typingStatusCheck)OK.logging.logger.success("discussions.typingAlreadyActivated");else{var e=n.options.typingCheckTimeout||1e3;n.typingStatusCheck=setInterval((function(){if(!n.isEditMode()){var e=o.data("previousText");if(e){var t=n.getValue().length,i=e.length;0===t?n.options.typingListener.onTypingStatusChanged(2):t!==i&&n.options.typingListener.onTypingStatusChanged(0)}o.data("previousText",n.getValue())}}),e)}n.options.isStickyForm&&!n.discussion.isPanelSticky()&&i.each((function(){n.discussion.scrollController.makeVisible(this)})),n.options.instantPaste||w(n),n.mentions&&n.mentions.hide(),OK.logging.logger.success("discussions.formActivate",n.discussion.scrollController.isScrolledToBottom())})).focus(T.bind(n,n)).one("focus",M.bind(n,n)),e=7,n.options.cleanOnPaste&&o.on("paste",(function(e){e.preventDefault();var t=(e.originalEvent||e).clipboardData;t?document.execCommand("insertText",!1,t.getData("text/plain")):window.clipboardData&&document.execCommand("paste",!1,window.clipboardData.getData("Text"))})),e=8;var g=function(){var e=n.isBlank();return n.container.toggleClass("__placeholder",e),e&&n.linksController.reset(),g};e=9,o.on("textchange",g()),e=10,n.initSmiles(),e=11,n.cancelBtn.click(t.proxy(this.onCancel,this)),n.official.length>0&&n.official.change(t.proxy(this.onOfficialChange,this)),e=12,n.changeState(E.states.initial,!0),e=13,x(n),n.options.instantPaste&&w(n),function(e){var t=O(e);t&&(t.addEventListener("click",(function(t){var n=t.target;n.classList.contains("usmile")&&(I(e),e.postToForm({content:n.getAttribute("data-code"),isSticker:!0,stickerPlace:null}))})),t.classList.toggle("__activated",!0),t.querySelector(".instant-comments_stickers").addEventListener("click",(function(){var t=e.textarea.data("emojiarea");t&&t.$button.click()})))}(n)}catch(t){OK.logging.logger.success("messagesLayer","e.commFormInit_"+e)}return this},beforeFormSubmit:function(){},scheduleMessage:function(){},destroy:function(){if(S(this),this.textarea.off(),this.textarea.emojiareaOff&&this.textarea.emojiareaOff(),this.textarea.removeData(),this.container.off(".cC"),t(document).off(".cF"),t(".js-comments_smiles_trigger",this.container).off("click"),this.cancelBtn.off(),this.form.off(),this.stickerSuggester&&this.stickerSuggester.destroy(),this.onPasteUploader&&this.onPasteUploader.deactivate(),this.persistants&&this.persistants.off(),this.mentions&&(this.mentions.hide(),this.mentions.unbind()),this.objectId){var e=s.get(this.objectId);e.off("update"),e.off("instantSendAttaches")}},isEmpty:function(){var e=this.getValue().trim().replace(/[\n\s]+/gi,"");return 0===e.length||p&&e===v},isBlank:function(){var e=this.getValue();return 0===e.length||p&&e===v},showNotification:function(e){this.label&&this.label.show(e)},showNotificationAboutNew:function(e){this.label&&this.label.showAsNew(e)},onSuccess:function(e,n){var i=this,s=e.getResponseHeader(OK.navigation.HEADER).split(",")[0],o=n.split(OK.navigation.SPLITER)[0],r=function(e){i.isEditMode()||(i.discussion.scrollController.hasMore()?setTimeout(i.showNotification.bind(i,e),100):e&&e.element.each((function(){i.discussion.scrollController.isVisibleBottomOf(this)||setTimeout(i.showNotification.bind(i,e),100)})));i.options.instantSending||i.resetState()},a=i.discussion.commentsCount;OK.logging.logger.success("discussions.commentPosted",a<=5?a:a<=10?10:a<=20?20:a<=50?50:"50+"),i.isEditMode()?(n&&(OK.hookModel.setHookContent(s,n.split(OK.navigation.SPLITER)[0]),i.comment.init(t(OK.hookModel.getHookById(s).element.firstChild))),r(i.comment)):i.discussion.post(s,o).always(r)},createRequest:function(e,n,i,s){var o=this,r=t.param(e),a=function(){},l=(n=n||a,i=i||a,s=s||a,t.ajax({type:"POST",headers:{TKN:OK.tkn.get()},url:o.getSubmitUrl(),data:r+"&gwt.requested="+window.pageCtx.gwtHash,beforeSend:n}));return l.done((function(e,t,n){try{"true"===n.getResponseHeader("failed")?i(OK.util.parseJSON(e)):o.onSuccess(n,e)}catch(e){throw i(),e}})),l.fail(i).then(s),l.always((function(){o.isInProgress=!1,o.posted&&o.posted.resolve()})),l.then((function(){I(o),function(e){var t=e.container&&e.container[0]&&e.container[0].closest(".plc");t&&d.animateVScroll(t,t.scrollHeight)}(o)}))},getSubmitUrl:function(){return this.form.attr("action")},clear:function(){this.fullText=null,this.setValue("").changeState(E.states.error,!1).changeState(E.states.progress,!1),this.objectId&&s.clear(this.objectId),this.linksController.reset()},onCancel:function(e){this.discussion.replyMode(!1),this.discussion.editMode(!1),e.preventDefault()},onOfficialChange:function(){this.official.length>0&&(this.official.prop("checked")?(this.userAvatar.hide(),this.groupAvatar.show()):(this.groupAvatar.hide(),this.userAvatar.show()))},getAttachesCount:function(){var e=this.attached.val(),t=e&&""!==e?JSON.parse(this.attached.val()):[];return(t=t.filter((function(e){return"VIDEOERROR"!==e.type}))).length},isValid:function(){return!this.isEmpty()||this.getAttachesCount()>0},deactivate:function(e){return this.options.collapsable&&(t(document).off("click.cF"),this.textarea.off("keydown.esc change.valid textchange.valid"),this.container.off("click.cC"),!e&&this.isValid()||this.changeState(E.states.initial).changeState(E.states.error,!1).changeState(E.states.active,!1)),this.mentions&&this.mentions.hide(),this},setComment:function(e){return this.comment=e,this.replyCommentIdInput.val(this.comment?this.comment.id:""),this},resetState:function(){var e=this;e.clear(),e.discussion.replyMode(!1),e.isEditMode()&&e.discussion.editMode(!1)},activateEditMode:function(e){if(this.replyMode=!1,this.comment=e,this.setValue(e.getText()),this.objectId){var t=e.getAttachments();s.clear(this.objectId),s.add(this.objectId,t),this.linksController=new r(this.objectId)}return this.setCaretToEnd(),this.textarea.focus(),this.official.length>0&&(this.official.prop("checked",e.official),this.onOfficialChange(),this.officialContainer.hide()),this.changeState(E.states.cancelable),this},activateReplyMode:function(e){return this.replyMode=!0,this.setComment(e),this.setCaretToEnd(),this.textarea.focus(),this.official.length>0&&e.official&&(this.options.canReplyFromGroup=this.official.prop("checked"),this.official.prop("checked",!1),this.onOfficialChange(),this.officialContainer.hide()),this.changeState(E.states.cancelable),this._preparePhotoLayerReplyMode(e),this},_preparePhotoLayerReplyMode:function(e){var t=this.container[0],n=t&&t.closest(".plc"),i=e&&e.element&&e.element[0];if(t&&n&&i){I(this);var s=t.getBoundingClientRect().top,o=i.getBoundingClientRect().bottom;s<o&&d.animateVScroll(n,o-s)}},cancelReplyEditMode:function(){var e=this;e.isReplyMode()?e.discussion.replyMode(!1):(e.discussion.editMode(!1),e.collapse().deactivate(!0).textarea.blur())},deactivateReplyEditMode:function(){return this.isReplyMode()||this.isEditMode()?(this.options.canReplyFromGroup&&(this.official.prop("checked",!0),this.userAvatar.hide(),this.groupAvatar.show(),this.officialContainer.show()),this.isEditMode()&&(this.linksController=new r(this.objectId)),this.clear(),this.replyMode=!1,this.official.length>0&&this.officialContainer.show(),this.setComment(null),this.deactivate(!0),this.changeState(E.states.cancelable,!1),this):this},changeState:function(e,t){var n=0;try{if(t=null==t||t,n=1,this.states[e]===t)return this;n=2;var i=this;return e&&(n=3,e!=E.states.initial&&t&&(n=4,i.changeState(E.states.initial,!1)),n=6,i.options.commentAreaContainer.toggleClass(e,t),n=7,i.options.onStateChanged.call(i.textarea,e,t),n=8,i.states[e]=t,n=9,i.textarea.trigger("commentForm.stateChanged",[e,t]).trigger("autosize.resize")),this}catch(e){OK.logging.logger.success("messagesLayer","e.commFormState_"+n)}},onStateChange:function(e){this.options.onStateChanged=e},getValue:function(e){if(this.fullText)return this.fullText;var t=this,n=["p","div","pre","form"];return function(){var i=[],s=[];function o(){i.push(s.join("")),s=[]}function r(t){if(3===t.nodeType){var i=t.nodeValue;p&&(i=i.replace(new RegExp(v,"g"),"")),s.push(i)}else if(1===t.nodeType){var a=t.tagName.toLowerCase(),l=-1!==n.indexOf(a);if(l&&s.length&&o(),"img"===a){if(e){var c=t.getAttribute("alt")||"";c&&s.push(c)}else s.push(t.outerHTML);return}if("br"===a)o();else if(t.hasAttribute("data-user-id")||t.hasAttribute("data-group-id"))return void s.push(t.outerHTML);for(var u=t.childNodes,h=0;h<u.length;h++)r(u[h]);l&&s.length&&o()}}if(t.textarea.length>0)for(var a=t.textarea[0].childNodes,l=0;l<a.length;l++)r(a[l]);return s.length&&o(),i.join("\n")}().replace(/<br\s*[\/]?>/gi,"\n")},setValue:function(e){return this.textarea.html(e),""===e&&this.isEmpty()&&x(this),this.textarea.trigger("textchange").trigger("autosize.resize"),this},serialize:function(e){var i=e.content,s=e.isSticker,o=e.attached||this.attached&&this.attached.val(),r=s&&this.options.sendStickerAsAttach,a={"st.dOFC":this.official.length>0&&this.official.prop("checked")?"on":"off","st.dAGid":this.container.attr("data-author-groupId"),"st.dM":r?"":i||this.getValue(!0),"st.dRT":null===this.comment?"off":"on"};r&&(o=JSON.stringify([{type:"STICKER",code:i}])),o&&o.length>0&&(!s||r)&&t.extend(a,{"st.attached":o});var l=this.linksController.getAttachedLinks();l.length>0&&!s&&(l=t.map(l,(function(e,t){return n.encodeHtml(e)})),t.extend(a,{links:l.join(",")}));var c=Math.round((new Date).getTime()*Math.random());if(this.isEditMode()){var u="editComment-"+c;t.extend(a,{"st.tlb.act":"actEC","st.cntId":this.comment.blockHookId,"st.refId":u})}else{var h="cf"+c,d="sendComment-"+c;t.extend(a,{"st.tlb.act":"actSC","st.cntId":h,"st.refId":d})}return this.comment&&t.extend(a,{"st.cId1":this.comment.id}),a},isEditMode:function(){return this.comment&&!this.replyMode},isReplyMode:function(){return this.comment&&this.replyMode},focus:function(){this.textarea.focus()},collapse:function(){this.fullText=this.getValue();var e=this;if(e.options.collapseText){var t=[],n=[],i=this.fullText.replace(/<img.*?>/gi,(function(e,i){return t.push(e),n.push(i),""}));i.length>50&&(i=i.substring(0,50)+"…");for(var s=0,o=t.length;s<o&&!(n[s]>=i.length);s++)i=i.substr(0,n[s])+t[s]+i.substr(n[s]);this.setValue(i)}return this.changeState(E.states.active,!1),setTimeout((function(){e.textarea.trigger("textchange").trigger("autosize.resize")}),10),this.textarea.one("focus",(function(){e.expand()})),e.options.collapseText||e.focus(),this},expand:function(){return this.fullText&&(this.setValue(this.fullText.replace(/\n/g,"<br>")),this.fullText=null,this.changeState(E.states.active),this.setCaretToEnd()),this},extendedEmojiareaOptions:function(){return{stickerSource:function(){return"discussions"},commentsWrapperEl:this.discussion.element}},postToForm:function(e){var t=this,n=t.serialize(e);return t.isReplyMode()&&t.discussion.replyMode(!1),t.createRequest(n,null,(function(e){if(e&&("STICKER_SERVICE_UNAVAILABLE"===e.type||"STICKER_SERVICE_UNAVAILABLE_VIP"===e.type)){var t="STICKER_SERVICE_UNAVAILABLE_VIP"===e.type?33:19;require(["OK/emojiarea"],(function(e){e.callStickerSetLayer(t)}))}}))},instantSendAttaches:function(e,t){var n,i=this;t&&t.length&&(t.forEach((function(e){n=i.serialize({content:" ",attached:"["+JSON.stringify(e)+"]"}),i.createRequest(n)})),i.isReplyMode()&&i.discussion.replyMode(!1))},serializeAttaches:function(e){return this.serialize({content:" ",attached:"["+JSON.stringify(e)+"]",instantAttachSend:!0})},sendUploadedAttaches:function(e,t){},initSmiles:function(){var e=this,n=0;try{if(!e.emojiarea){n=1;var i=t(".js-comments_smiles_trigger",e.container);n=2;var s=t.extend({button:i,postFunction:e.postToForm.bind(e),scrollingContainer:e.discussion.scrollController.element,stickerSuggester:e.stickerSuggester,needStickerOnSmileSuggester:!!e.container.find(".js-smile-st-suggest").length},e.extendedEmojiareaOptions());n=3,t.fn.emojiarea&&(n=30,e.textarea.emojiarea(s)),n=4,e.emojiarea=!0}}catch(e){OK.logging.logger.success("messagesLayer","e.commFormSmile_"+n)}},setCaretToEnd:function(e){var t=this,n=function(){t.textarea.each((function(){var e=document.createRange();e.selectNodeContents(this),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)})),t.textarea.trigger("change")};e?n():setTimeout(n,5)},checkStickyRecalculate:function(e){var t=this.options.stickyContainerParent.outerHeight(),n=this.options.stickyContainer.outerHeight();t!==n&&e(t,n)},initAutosize:function(){var e=this;this.textarea.autosize({onBeforeResize:function(){var t=0;try{var n=e.discussion;t=1;var i=n.scrollController;t=2;var s=i&&i.isScrolledToBottom&&i.isScrolledToBottom();t=3,this.scrolledToBottom=s}catch(e){OK.logging.logger.success("messagesLayer","e.commFormoOnBeforeResize_"+t)}},callback:function(){e.options.stickyContainer&&e.options.stickyContainerParent&&(e.checkStickyRecalculate((function(t,n){e.discussion.scrollController.scroll(n-t),e.options.stickyContainerParent.css({minHeight:e.options.stickyContainer.outerHeight()})})),this.scrolledToBottom&&e.discussion.scrollController.scrollToBottom(),e.options.stickyContainer.scrollTop(e.options.stickyContainer.prop("scrollHeight")))}})},whenPosted:function(e){this.isInProgress?this.posted.done(e):e()},onAttachUpdate:function(){if(this.options.isStickyForm&&this.options.stickyContainer&&this.options.stickyContainerParent){var e=this;requestAnimationFrame((function(){e.checkStickyRecalculate((function(){e.options.stickyContainerParent.css({minHeight:e.options.stickyContainer.outerHeight()})}))}))}this.setCaretToEnd(),this.discussion.scrollController.trigger()}},E.linkParsingHandler=L,E})),define("OK/discussions/Comment",["jquery","OK/discussions/CommentForm","OK/utils/utils"],(function(e,t,n){var i=function(e,t,n){2===arguments.length&&(n=new Date(e.data("time"))),this.discussion=t,this.time=n,this.level=parseInt(e.data("level")),this.url=e.data("url"),this.userId=e.data("uid"),this.unseen=!1,this.init(e)};return i.prototype={init:function(t){this.element=t,this.parent=this.element.parent(),this.blockHookId=OK.hookModel.getNearestBlockHookId(this.element.get(0)),this.contentBlockHookId=this.element.data("cid")+"",this.contentContainer=e("#hook_Block_"+this.contentBlockHookId,this.element),this.textContainer=e(".comments_text",this.contentContainer),this.id=this.element.data("id"),this.content=this.contentContainer.html(),this.official=t.data("official"),this.initHandlers()},initHandlers:function(){this.element.on("click",".comments_cancel-reply",e.proxy(this.cancel,this))},destroy:function(){this.element.off("click",".comments_cancel-reply"),this.element.off(),this.element.removeData()},edit:function(){var e=this;this.discussion.editMode(!0,this),this.element.each((function(){e.discussion.scrollController.isVisibleBottomOf(this)||e.discussion.scrollController.scrollToBottom(this)}))},setContent:function(e){OK.hookModel.setHookContent(this.contentBlockHookId,e)},initExpand:function(){var e=this;require(["OK/discussions/Reveal"],(function(t){e.element.each((function(){t.activate(this)}))}))},expand:function(){var e=this;require(["OK/discussions/Reveal"],(function(t){e.element.each((function(){t.expand(this)}))}))},cancelEdit:function(){this.discussion.editMode(!1),this.setContent(this.content)},cancel:function(e){return this.element.trigger("comment.cancel"),e.preventDefault(),e.stopPropagation(),this},select:function(){return this.element.addClass("__active"),this},refresh:function(){return e.ajax({type:"POST",headers:{TKN:OK.tkn.get()},data:{"gwt.requested":window.pageCtx.gwtHash},url:this.url}).done((function(e,t,n){for(var i=e.split(OK.navigation.SPLITER),s=n.getResponseHeader(OK.navigation.HEADER).split(","),o=0;o<i.length;o++)s[o]&&OK.hookModel.setHookContent(s[o],i[o])})),this},bind:function(e,t){return this.element.on(e,t),this},unbind:function(e,t){return this.element.off(e,t),this},deselect:function(){this.element.removeClass("__active")},highlight:function(e){var t=this;t.element.addClass("__highlight"),void 0===e&&(e=!0),e&&setTimeout((function(){t.element.removeClass("__highlight")}),3e3)},updateKlass:function(){var e=this.element.data("classurl"),t=this;e&&n.ajax({type:"POST",url:e}).done((function(e,i,s){t.highlight(),n.updateBlockModelCallback(e,i,s)}))},getAttachments:function(){return this.element.data("attaches")||[]},getText:function(){var e=this,t=["p","div","pre","form"];return function(){var n=[],i=[];function s(){n.push(i.join("")),i=[]}function o(e){if(3===e.nodeType){var n=e.nodeValue;i.push(n)}else if(1===e.nodeType){var r=e.tagName.toLowerCase(),a=-1!==t.indexOf(r);if(a&&i.length)return void s();if("img"===r)return void i.push(e.outerHTML);if("br"===r)s();else if(e.hasAttribute("data-user-id")||e.hasAttribute("data-group-id"))return void i.push(e.outerHTML);for(var l=e.childNodes,c=0;c<l.length;c++)o(l[c]);a&&i.length&&s()}}if(e.textContainer.length>0)for(var r=e.textContainer[0].childNodes,a=0;a<r.length;a++)o(r[a]);return i.length&&s(),n.join("")}()}},i})),define("OK/discussions/CommentEntry",[],(function(){var e=function(e,t){this.element=e,this.comment=t,this.next=null,this.prev=null};return e.prototype={append:function(e){return this.comment.id!==e.comment.id&&(this.next=e,e.prev=this,e.element.insertAfter(this.element),!0)},prepend:function(e){return this.comment.id!==e.comment.id&&(this.prev&&(this.prev.next=e),this.prev=e,e.next=this,e.element.insertBefore(this.element),!0)},compare:function(e){return this.comment.time.getTime()-e.comment.time.getTime()}},e})),define("OK/ReplyList",["require","jquery","OK/logger","OK/utils/utils","OK/utils/dom"],(function(require){"use strict";var e=require("jquery"),t=(require("OK/logger"),require("OK/utils/utils")),n=require("OK/utils/dom"),i=function(e){this.toggleClick=e&&e.toggleClick,this.clearOnDestroy=e&&e.clearOnDestroy,this.onlyOnClick=e&&e.onlyOnClick};return i.prototype={init:function(t){this.container=e(t);var n=this.onlyOnClick?"click":"hover click";this.container.on(n,".comments_replied",e.proxy(this.showReply,this))},destroy:function(){if(this.onlyOnClick||this.container.off("hover"),this.container.off("click"),this.clearOnDestroy){var e=n.byClass(this.container[0],"comments_reply-comment");e&&e.forEach((function(e){e.classList.contains("__show")&&!e.classList.contains("__popup")&&(e.classList.remove("__show"),e.classList.add("__popup"))}))}},showReply:function(n){var i=e(n.target).closest(".comments_replied");if(0!=i.length){var s=this,o=i[0],r=i.data("url");parseInt(i.data("level"),10);if(o.embedded){if(s.toggleClick){var a=o.reply.hasClass("__show")&&!o.reply.hasClass("__popup");"click"===n.type?c():a||"mouseenter"!==n.type?a||"mouseleave"!==n.type||h():u()}}else{var l=s.onlyOnClick&&"click"===n.type;("mouseenter"===n.type||l)&&(o.reply||o.requested?u():(o.requested=!0,t.ajax({url:r}).done((function(t,n,i){for(var s=t.split(OK.navigation.SPLITER),r=i.getResponseHeader(OK.navigation.HEADER).split(","),a=0;a<s.length;a++){var h=r[a];if(h){var d=OK.hookModel.getHookById(h).element,f=e(d);f.children().addClass("__active __popup"),OK.hookModel.setHookContent(h,s[a]),o.reply=f,l?c():u()}}})))),"mouseleave"===n.type&&h(),"click"===n.type&&(o.embedded=!0,c())}n.preventDefault()}function c(){var e=o.reply;e&&(e.hasClass("__show")&&!e.hasClass("__popup")?s.toggleClick&&(e.addClass("invisible"),setTimeout((function(){e.removeClass("__show invisible").addClass("__popup")}),100),s.scroller&&s.scroller.scroll(-e.height())):(e.removeClass("__popup").addClass("__show").children().removeClass("__active __popup"),s.scroller&&(s.scroller.scroll(e.height()),e.each((function(){s.scroller.makeVisible(this)})))))}function u(){o.showTimeout=setTimeout((function(){var t=o.reply||e();t.addClass("__show"),o.arrow||(o.arrow=t.find(".comments_reply-comment_arrow").css("left",(function(){return i.offset().left-t.offset().left})))}),300)}function h(){setTimeout((function(){clearTimeout(o.showTimeout),(o.reply||e()).removeClass("__show")}),100)}}},i})),define("OK/discussions/CommentsList",["jquery","OK/discussions/Comment","OK/discussions/CommentEntry","OK/ReplyList"],(function(e,t,n,i){var s=function(t,n,s){this.selectedComment=null,this.container=e(t),this.discussion=s,this.scroller=n,this.last=null,this.parentHookId=OK.hookModel.getNearestBlockHookId(t),this.replyList=new i};return s.prototype={init:function(){this.replyList.init(this.container),this.container.on("mousedown click",".comments_reply",e.proxy(this.reply,this)).on("click","a.comments_edit",e.proxy(this.edit,this)).on("click",".comments_text_more",e.proxy(this.expandComment,this)),this.initExpandComments()},destroy:function(){this.container.off("hover click",".comments_replied"),this.container.off("mousedown click",".comments_reply"),this.container.off("click","a.comments_edit"),this.container.off("click",".comments_text_more");var t=e(".comments_i",this.container);t.off("click",".comments_cancel-reply"),t.off(),t.removeData()},createListHead:function(){var i=this.container.children();if(0==i.length)return null;var s=i.last(),o=new t(e(".comments_i",s),this.discussion);return new n(s,o)},getLast:function(){return this.last&&e.contains(this.container.get(0),this.last.element.get(0))||(this.last=this.createListHead()),this.last},getComment:function(e){var n=e.closest(".comments_i");return new t(n,this.discussion)},editLast:function(){var t=e("a.comments_edit:last",this.container);0!=t.length&&this.editComment(this.getComment(t))},edit:function(t){this.editComment(this.getComment(e(t.target))),t.preventDefault(),t.stopPropagation()},expandComment:function(t){this.getComment(e(t.target)).expand()},editComment:function(e){var t=this.selectedComment;t&&t.cancelEdit();var n=this;e.bind("comment.cancel",(function(){n.discussion.editMode(!1)})),e.edit(),this.selectedComment=e,OK.logging.logger.success("discussions.commentEdit","click")},reply:function(t){if("mousedown"!==t.type){var n=this,i=this.getComment(e(t.target));i.bind("comment.cancel",(function(){n.discussion.replyMode(!1)})),OK.logging.logger.success("discussions.commentReply","click"),n.discussion.replyMode(!0,i),t.preventDefault()}t.stopPropagation()},selectComment:function(e){if(e&&(this.deselectComment(this.selectedComment),this.container.addClass("__blur"),this.selectedComment=e,e.select(),this.discussion.elements.stickyContainer.length>0)){var t=this.discussion.elements.stickyContainer.offset().top,n=e.element.offset().top+e.element.outerHeight()-t;n>0&&this.scroller.scroll(n+10)}},deselectComment:function(e){(e=e||this.selectedComment)&&(e.deselect(),this.container.removeClass("__blur"),this.selectedComment=null)},addNewComment:function(i,s){var o=e.Deferred();if(this.scroller.hasMore())return o.resolve(null);var r=this,a=e('<div id="hook_Block_'+i+'">').html(s),l=new t(e(".comments_i",a),this.discussion),c=new n(a,l),u=this.scroller.isScrolledToBottom();u&&this.discussion.toggleStickyPanel(!1);var h=this.getLast(),d=!1;if(h)if(c.compare(h)>=0)(d=h.append(c))&&(this.last=c);else{for(var f=h;null!=f.prev&&c.compare(f.prev)<=0;)f=f.prev;d=f.prepend(c)}else d=!0,this.last=c,this.container.append(c.element),e(document.createElement("div")).addClass("comments_first_sep").appendTo(a);return u&&(this.scroller.scroll(c.element.outerHeight()),this.discussion.toggleStickyPanel(!0)),d&&a.each((function(){r.parentHookId&&OK.hookModel.captureBlockHook(r.parentHookId,this)})),d?o.resolve(l):o.fail(l),o.promise()},updateComment:function(e){var t=this.findComment(e);t&&t.refresh()},findComment:function(n){if(n){var i=e('[data-id="'+n+'"]',this.container);if(0!=i.length)return new t(i,this.discussion)}return null},findCommentsFromAuthor:function(n){var i=this,s=[];return e(".comments_i",this.container).each((function(){var o=e(this);n==o.data("uid")&&s.push(new t(o,i.discussion))})),s},deleteStub:function(t,n){var i=OK.hookModel.getHookById(t).element,s=e("input[type=checkbox]",i),o=e(i);o.find(".block-user").change((function(){var t=e(i).find(".delete-content");t.toggleClass("invisible"),t.find("input[type=checkbox]").prop("checked",!1)})),s.change((function(){var t=!0;s.each((function(){t=t&&!this.checked})),e(".comments_delete_form-action",i).toggleClass("invisible",t)}));var r=o.find(".lsid").val();window&&window.localStorage&&r&&(!function(t){var n=window.localStorage.getItem(t);if(n){s.each((function(t){-1!=n.indexOf("c"+t)&&e(this).prop("checked","checked").trigger("change")}));for(var i=o.find(".block-user-dd"),r=i.find("option"),a=0;a<r.length;a++)if(-1!=n.indexOf("bu"+a)){r.eq(a).attr("selected","selected"),i.trigger("change");break}var l=o.find(".delete-content-dd"),c=l.find("option");for(a=0;a<c.length;a++)if(-1!=n.indexOf("dd"+a)){c.eq(a).attr("selected","selected"),l.trigger("change");break}}}(r),o.find(".comments_delete_form-action").click((function(){var t="";(s.each((function(n){e(this).prop("checked")&&(t+="c"+n)})),o.find(".block-user").prop("checked"))&&o.find(".block-user-dd option").each((function(n){if(e(this).prop("selected"))return t+="bu"+n,!1}));o.find(".delete-content-cb").prop("checked")&&o.find(".delete-content-dd option").each((function(n){if(e(this).prop("selected"))return t+="dd"+n,!1}));t&&window.localStorage.setItem(r,t)})))},isVisible:function(e){return this.scroller.isVisible(e.element.get(0))},highlightUnseen:function(){for(var e=this.getLast();e;)e.comment.unseen&&(e.comment.highlight(),e.comment.unseen=!1),e=e.prev},getFirstUnseen:function(){for(var e=this.getLast();e;){if(!e.comment.unseen){var t=e.next;return t?t.comment:null}e=e.prev}return null},initExpandComments:function(){var t=this;e(".comments_i",this.container).each((function(n,i){t.getComment(e(i)).initExpand()}))}},s})),define("OK/discussions/TypingStatus",["jquery"],(function(e){var t=function(e,t){this.element=e,this.discussion=t,this.currentStatus=0,this.typingUsers=[]};function n(t){var n="",i="";return e.each(t,(function(){var e=this.uf;e&&(n+=i,n+=e,i=", ")})),n}return t.prototype={init:function(){return this.inited||(this.usersContainer=e(".comments-typing_tx",this.element),this.inited=!0),this},show:function(){var e=this.discussion.scrollController.isScrolledToBottom();return this.element.removeClass("invisible"),e&&this.discussion.scrollController.scrollToBottom(),this},hide:function(){return this.element.addClass("invisible"),this},setTypingUsers:function(e){return this.typingUsers=e,this.show().setStatus(0).usersContainer.html(n(e)),this},removeUser:function(t){var i=this;e.each(this.typingUsers,(function(e,n){if(parseInt(this.ul,10)===t)return i.typingUsers.splice(e,1),!1})),0===this.typingUsers.length?this.hide():this.usersContainer.html(n(this.typingUsers))},setStatus:function(t){return e(".comments-typing",this.element).removeClass("__status-"+this.currentStatus).addClass("__status-"+t),this.currentStatus=t,this}},t})),define("OK/utils/textchange",["jquery"],(function(e){return e.event.special.textchange={setup:function(t,n){e(this).data("lastValue","true"===this.contentEditable?e(this).html():e(this).val()),e(this).bind("keyup.textchange",e.event.special.textchange.handler),e(this).bind("cut.textchange paste.textchange input.textchange",e.event.special.textchange.delayedHandler)},teardown:function(t){e(this).unbind(".textchange").removeData("lastValue")},handler:function(t){e.event.special.textchange.triggerIfChanged(e(this))},delayedHandler:function(t){var n=e(this);setTimeout((function(){e.event.special.textchange.triggerIfChanged(n)}),25)},triggerIfChanged:function(e){var t="true"===e[0].contentEditable?e.html():e.val();t!==e.data("lastValue")&&(e.trigger("textchange",[e.data("lastValue")]),e.data("lastValue",t))}},e.event.special.textchange})),define("OK/Discussion",["require","jquery","OK/DiscussionManager","OK/discussions/ScrollController","OK/discussions/CommentsList","OK/discussions/CommentForm","OK/discussions/TypingStatus","OK/utils/textchange","OK/utils/utils"],(function(require){var e,t=require("jquery"),n=require("OK/DiscussionManager"),i=require("OK/discussions/ScrollController"),s=require("OK/discussions/CommentsList"),o=require("OK/discussions/CommentForm"),r=require("OK/discussions/TypingStatus"),a=(require("OK/utils/textchange"),require("OK/utils/utils")),l={containerId:null,commentsListContainerId:null,commentAreaId:null,commentAreaCounterId:null,commentAreaContainerId:null,scrollingContainerId:null,lastCommentsUrl:null,isStickyForm:!0,stickyContainerId:null,isFormActiveByDefault:!1,mentionsEnabled:!1,groupMentionsEnabled:!1,mentionsCharStart:3,participantsSearchEnabled:!1,batchUnsubscribe:!1},c={};function u(){var e=Object.keys(c);c={},a.ajax({url:"/dk?cmd=DiscussionsUnsubscribe",data:{"st.dIds":e.join(",")}})}var h=function(e,n,s,o,r){this.id=n,this.type=s,this.element=e,this.options=t.extend({},l,r||{});var a=t(".comments_cnt",this.element),c=t(".comments_sticky",this.element),u=t(".js-addFormContainer",this.element);this.elements={container:a,commentsListContainer:t(".comments_lst_cnt",this.element),commentArea:t(".js-comments_add",u),commentAreaContainer:t(".js-comments_form",u),stickyContainer:c,stickyContainerParent:c.parent(),scrollingContainer:this.options.scrollingContainerId?document.getElementById(this.options.scrollingContainerId):window,collapseText:"true"!==e.attr("data-autofocus")},this.scrollController=new i(this.elements,this.options.loaderId),this.setCount(o)};return h.prototype={getId:function(){return this.type+"_"+this.id},getId2:function(){return this.id+"_"+this.type},getTypeString:function(){return this.typeString?this.typeString:this.typeString=this.element.attr("data-types")},focusForm:function(e,t){this.form.focus()},init:function(){var e=this;if(t.data(this.element,"instance"))return this;var n=e.form=new o(e.elements.commentArea,e,e.elements);(e.list=new s(e.elements.commentsListContainer[0],e.scrollController,e)).init(),n.init().textarea.one("focus",(function(){n.onStateChange((function(t){if(t==o.states.active||t==o.states.error){var n=e.elements.stickyContainer.outerHeight();e.elements.stickyContainer.parent().css({minHeight:n}),e.elements.stickyContainer.each((function(){e.scrollController.isVisibleBottomOf(this)||e.isPanelSticky()||e.scrollController.scroll(n)}))}}))}));var i,r=t("#mtLayer");e.element.closest(r).length>0&&r.one("mtLayer.close",(function(){e.unsubscribe(),e.editMode(!1)})),t(".js-friendsList",this.element).on("click",".js-name",(function(n){var s=t(this),o=s.attr("data-uid");function r(){var n=e.list.findCommentsFromAuthor(o);return t.each(n,(function(){this.highlight(!0)})),n.length>0&&e.scrollController.scrollToTopOf(n[0].element.get(0)),n.length>0}OK.logging.logger.success("discussions.findFriendComment","click"),r()?OK.logging.logger.success("discussions.findFriendComment","foundCurrentPage"):e.scrollController.load(s.attr("href")).done(r).fail((function(n){n.responseText&&(n=n.responseText),i||(i=t(document.createElement("div"))).prependTo(e.element),i.html(n).find(".tipDiscussion").addClass("__active"),setTimeout((function(){t(".tipDiscussion",i).removeClass("__active")}),3e3),OK.logging.logger.success("discussions.findFriendComment","notFound")})),n.preventDefault()})).on("click",".js-showAll",(function(e){t(this).addClass("invisible"),t(".js-nameCnt",e.delegateTarget).removeClass("invisible")}));var a=e.element.data("cid"),l=e.element.data("scroll-to-unread");if(a){var c=e.list.findComment(a);c&&c.element.each((function(){e.scrollController.scrollToCenter(this),c.highlight(!0)}))}else if(l){var u=t(".comments_i.__is-unread",e.elements.commentsListContainer);0!==u.length?e.scrollController.scrollTo(u[0],-100):e.scrollController.scrollToBottom()}return this},destroy:function(){this.needToUnsubscribe()&&this.unsubscribe(),this.editMode(!1),this.replyMode(!1);var e=t(".js-friendsList",this.element);e.off("click",".js-name"),e.off("click",".js-showAll"),this.element.removeData(),this.form.destroy(),this.list.destroy(),this.elements.container.off(),this.stickyPanel&&this.stickyPanel.deactivate()},post:function(e,t){var n=this;return n.list.addNewComment(e,t).done((function(e){n.updateCount(1),n.scrollController.trigger(),e&&n.pen&&n.pen.removeUser(e.userId)}))},postPush:function(e,t,n){return this.post(e,t)},replyMode:function(e,t){var n=this.form,i=this.list;e?(n.activateReplyMode(t),i.selectComment(t)):(n.deactivateReplyEditMode(),i.deselectComment())},editMode:function(e,t){var n=this.form,i=this.list;e?(n.activateEditMode(t),i.selectComment(t)):(n.deactivateReplyEditMode(),i.deselectComment())},refresh:function(e){if(this.options.lastCommentsUrl){var n=this.list,i={"gwt.requested":window.pageCtx.gwtHash},s=n.getLast();s&&t.extend(i,{"st.cId1":s.comment.id});var o={type:"POST",headers:{TKN:OK.tkn.get()},data:t.extend(i,{"st.dCo":e||1}),url:this.options.lastCommentsUrl.replace(/&amp;/g,"&")};return t.ajax(o)}},updateComment:function(e){this.list.updateComment(e)},subscribe:function(){n.add(this)},unsubscribe:function(){if(this.options.batchUnsubscribe)e&&clearTimeout(e),c[this.getId2()]=!0,e=setTimeout(u,1e3);else{var t=this.element.attr("data-unurl");t&&a.ajax({url:t})}n.remove(this)},showLatest:function(e){var t=this;this.scrollController.hasMore()?this.scrollController.loadMore().done((function(){t.markAsRead(),t.pen&&t.pen.hide()})):(e?e.element.each((function(){t.options.isStickyForm?t.scrollController.scrollToCenter(this):t.scrollController.scrollTo(this)})):this.list.getLast().comment.element.each((function(){t.options.isStickyForm?t.scrollController.scrollToCenter(this):t.scrollController.scrollTo(this)})),t.markAsRead(),t.list.highlightUnseen())},toggleStickyPanel:function(e){e||this.elements.stickyContainer.removeClass("__on").addClass("__off"),this.scrollController.trigger()},isPanelSticky:function(){return this.stickyPanel&&this.stickyPanel.isStickyOn()},updateCount:function(e){this.setCount(this.commentsCount+e)},setCount:function(e){var n=this;this.commentsCount=Math.max(e,0),t(".comments_h",this.element).each((function(){var e=t(this),i=e.find(".lstp-t");e.toggleClass("__hidden",n.commentsCount<1),i.html(n.commentsCount.toString().replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g,"$1&nbsp;"))})),require(["OK/CommentWidgetsController"],(function(e){e.setCount(n.id,n.type,n.commentsCount)})),this.commentsCount>0&&(this.element.removeClass("__empty"),function(e){e.options.isStickyForm&&require(["OK/StickyPanel"],(function(n){var i=t(".comments_first_sep",e.elements.container);0===i.length&&(i=e.elements.container),e.stickyPanel=new n,e.stickyPanel.activateWithOptions(e.elements.stickyContainer,{container:e.elements.scrollingContainer,bound:i})}))}(n),this.form&&this.form.initAutosize())},deleteComment:function(e,t){this.list.deleteStub(e,t),this.updateCount(-1),this.scrollController.trigger()},restoreComment:function(){this.updateCount(1)},markAsRead:t.noop,setTypingUsers:function(e){this.pen||(this.pen=new r(t(".comments_pen_cnt",this.element),this),this.pen.init()),this.pen.setTypingUsers(e)},resetTypingStatus:function(){this.pen&&this.pen.hide()},setTypingStatus:function(e){this.pen&&this.pen.setStatus(e)},processNewComments:function(e){var n=this;e.done((function(e){n.form.whenPosted((function(){!n.scrollController.hasMore()&&e&&(n.scrollController.isVisibleBottomOf(n.element[0])&&n.markAsRead(),t(e).each((function(){var e=t(this),i=e.attr("data-wId")||"nc"+Date.now(),s=n.postPush(i,e,!0===e.attr("data-own"));s&&s.done((function(e){n.processComment(e)}))})))}))}))},processComment:function(e){null!=e&&(this.list.isVisible(e)?e.highlight():(e.unseen=!0,this.form.showNotificationAboutNew(this.list.getFirstUnseen())))},needToSubscribe:function(){return!0},needToUnsubscribe:function(){return!0}},h})),define("OK/utils/delegate",[],(function(){"use strict";function e(t){this.listenerMap=[{},{}],t&&this.root(t),this.handle=e.prototype.handle.bind(this)}e.prototype.root=function(e){var t,n=this.listenerMap;if(this.rootElement){for(t in n[1])n[1].hasOwnProperty(t)&&this.rootElement.removeEventListener(t,this.handle,!0);for(t in n[0])n[0].hasOwnProperty(t)&&this.rootElement.removeEventListener(t,this.handle,!1)}if(!e||!e.addEventListener)return this.rootElement&&delete this.rootElement,this;for(t in this.rootElement=e,n[1])n[1].hasOwnProperty(t)&&this.rootElement.addEventListener(t,this.handle,!0);for(t in n[0])n[0].hasOwnProperty(t)&&this.rootElement.addEventListener(t,this.handle,!1);return this},e.prototype.captureForType=function(e){return-1!==["blur","error","focus","load","resize","scroll"].indexOf(e)},e.prototype.on=function(e,o,r,a){var l,c,u,h;if(!e)throw new TypeError("Invalid event type: "+e);if("function"==typeof o&&(a=r,r=o,o=null),void 0===a&&(a=this.captureForType(e)),"function"!=typeof r)throw new TypeError("Handler must be a type of Function");l=this.rootElement,(c=this.listenerMap[a?1:0])[e]||(l&&l.addEventListener(e,this.handle,a),c[e]=[]),o?/^[a-z]+$/i.test(o)?(h=o,u=n):/^#[a-z0-9\-_]+$/i.test(o)?(h=o.slice(1),u=s):(h=o,u=t):(h=null,u=i.bind(this));var d,f,m=c[e],g=!1;for(d=m.length-1;d>=0;d--)if(f=m[d],!(o&&o!==f.selector||r&&r!==f.handler)){g=!0;break}return g||m.push({selector:o,handler:r,matcher:u,matcherParam:h}),this},e.prototype.off=function(e,t,n,i){var s,o,r,a,l;if("function"==typeof t&&(i=n,n=t,t=null),void 0===i)return this.off(e,t,n,!0),this.off(e,t,n,!1),this;if(r=this.listenerMap[i?1:0],!e){for(l in r)r.hasOwnProperty(l)&&this.off(l,t,n);return this}if(!(a=r[e])||!a.length)return this;for(s=a.length-1;s>=0;s--)o=a[s],t&&t!==o.selector||n&&n!==o.handler||a.splice(s,1);return a.length||(delete r[e],this.rootElement&&this.rootElement.removeEventListener(e,this.handle,i)),this},e.prototype.handle=function(e){var t,n,i,s,o,r,a=e.type,l=[],c="ftLabsDelegateIgnore";if(!0!==e[c]){switch(3===(r=e.target).nodeType&&(r=r.parentNode),i=this.rootElement,e.eventPhase||(e.target!==e.currentTarget?3:2)){case 1:l=this.listenerMap[1][a];break;case 2:this.listenerMap[0]&&this.listenerMap[0][a]&&(l=l.concat(this.listenerMap[0][a])),this.listenerMap[1]&&this.listenerMap[1][a]&&(l=l.concat(this.listenerMap[1][a]));break;case 3:l=this.listenerMap[0][a]}for(n=l.length;r&&n;){for(t=0;t<n&&(s=l[t]);t++)if(s.matcher.call(r,s.matcherParam,r)&&(o=this.fire(e,r,s)),!1===o)return e[c]=!0,void e.preventDefault();if(r===i)break;n=l.length,r=r.parentElement}}},e.prototype.fire=function(e,t,n){return n.handler.call(t,e,t)};var t=function(e){if(e){var t=e.prototype;return t.matches||t.matchesSelector||t.webkitMatchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector}}(Element);function n(e,t){return e.toLowerCase()===t.tagName.toLowerCase()}function i(e,t){return this.rootElement===window?t===document:this.rootElement===t}function s(e,t){return e===t.id}return e.prototype.destroy=function(){this.off(),this.root()},e})),define("OK/AbstractShortcutMenu",["OK/utils/dom","OK/utils/vanilla","OK/utils/delegate"],(function(e,t,n){"use strict";var i="ShortcutMenu",s=null,o=document.createElement("div");function r(){this.holder=null,this.menuElement=null,this.showTimeout=null,this.hideTimeout=null,this.ajaxRequest=null,this.direction="",this.position="center",this._visible=!1,this.cancelShow=!1,this.inplace=!1,this.detectScrollableContainer=!1,this.menuElementHoverInListenerCalled=!1,this.activateTime=0,this.ignoreHoverTime=-1}return o.id="hook_Block_"+i,document.body.appendChild(o),OK.hookModel.captureBlockHook("body",o),o.addEventListener("change",(function(){s&&s.visible()&&s.positingElement()})),r.getActiveInstance=function(){return s},r.setActiveInstance=function(e){s=e},r.getBlockId=function(){return i},r.prototype.getBlock=function(){return this.inplace?this.block:o},r.prototype.getHtml=function(){},r.prototype.initListeners=function(e){this.shortcutMenuDelegate=new n(e),this.shortcutMenuDelegate.on("click",".sc-menu a",this.menuElementLinkClickListener.bind(this)),this.shortcutMenuDelegate.on("click",".sc-menu .js-hide",this.menuElementClickListener.bind(this)),this.shortcutMenuDelegate.on("click",".js-forceHide",function(e,t){this.hideMenu({forceHide:!t.classList.contains("js-supress-forceHide")})}.bind(this)),this.shortcutMenuDelegate.on("mouseenter",this.menuElementHoverInListener.bind(this)),this.shortcutMenuDelegate.on("mouseleave",this.hoverOutListener.bind(this)),OK.device.isTouch&&this.shortcutMenuDelegate.on("touchstart",this.holderTouchStartListener.bind(this))},r.prototype.processHTML=function(n){var i=[];this.inplace?(this.initBlock(),i[0]=this.blockId):i[0]=r.getBlockId();var s=this.getBlock();t.updateBlocks(n,i),this.initListeners(s),this.menuElement=e.firstByClass(s,"sc-menu"),this.positingElement(),this.menuElement.classList.remove("sc-menu__hidden"),this.holder.classList.add("__vis"),r.setActiveInstance(this),this._visible=!0},r.prototype.showMenu=function(){clearTimeout(this.hideTimeout),this.showTimeout=null,this.visible()||(s&&s.hide(),this.processHTML(this.getHtml()),t.trigger(this.holder,"shortcut-menu-show"),this.hideOnScroll&&(this.oneScrollListener={element:this.getClosestScrollable(!0),type:"scroll",handler:this.hoverOutListener.bind(this)},this.oneScrollListener.element.addEventListener("scroll",this.oneScrollListener.handler)))},r.prototype.hideMenu=function(e){this.clearShowTimeout(),this.clearHideTimeout(),t.trigger(this.holder,"shortcut-menu-hide",e),this.menuElement&&(this.menuElement.classList.add("sc-menu__hidden"),OK.hookModel.setHookContent(i,""),this.menuElement=null),this.holder.classList.remove("__vis"),this.shortcutMenuDelegate&&this.shortcutMenuDelegate.off(),this._visible=!1,this.removeOneTimeListener(this.oneScrollListener),r.setActiveInstance(null)},r.prototype.hide=function(){this.clearShowTimeout(),this.clearHideTimeout(),this.menuElement?this.hideMenu():this.ajaxRequest&&(this.cacheable?this.cancelShow=!0:this.ajaxClose())},r.prototype.getClosestScrollable=function(t){if(!this.closestScrollable){var n=/(auto|scroll)/,i=e.traverseParents(this.holder,(function(e){var i=window.getComputedStyle(e);return n.test(i.overflow+i.overflowY+i.overflowX)&&(!t||e.scrollHeight>e.clientHeight)}));this.closestScrollable=i||window}return this.closestScrollable},r.prototype.isTopDirection=function(e,t){var n=this.holder.getBoundingClientRect().top;if(this.detectScrollableContainer){var i=this.holder.getBoundingClientRect().height,s=this.getClosestScrollable(),o=n-s.getBoundingClientRect().top,r=s.clientHeight-i,a=s.scrollTop+o+i+t,l=s.scrollHeight;return r/2<o||a>l}return window.innerHeight-e-n<t},r.prototype.isInsideViewportWhileCentered=function(e){var t=this.holder.getBoundingClientRect(),n=t.left,i=window.innerWidth-OK.scrollBar.width;if(this.detectScrollableContainer){var s=this.getClosestScrollable().getBoundingClientRect();n-=s.left,i=s.right}var o=n+(t.width-e)/2;return o>0&&o+e<i},r.prototype.toRightFromHolder=function(e,t){if(this.detectScrollableContainer){var n=this.getClosestScrollable().getBoundingClientRect(),i=this.holder.getBoundingClientRect().left-n.left;return n.width/2>i}return window.innerWidth-OK.scrollBar.width>e.left+t},r.prototype.visible=function(){return this._visible},r.prototype.getOffset=function(e){var t=e.getBoundingClientRect();return{left:t.left+window.pageXOffset,top:t.top+window.pageYOffset}},r.prototype.positingElement=function(){var t,n=e.outerSize(this.holder,!1,!1),i=this.inplace?{top:0,left:0}:this.getOffset(this.holder),s=e.outerSize(this.holder,!0,!1),o=e.outerSize(this.menuElement,!0,!0),r=this.position;"center"!==r||this.isInsideViewportWhileCentered(o)||(r="auto"),"center"!==r&&"auto"!==r&&this.menuElement.classList.add("__noarrow");var a=e.outerSize(this.menuElement,!1,!0);t="top_force"===this.direction||"bottom_force"===this.direction?"top_force"===this.direction:"top"===this.direction?this.getOffset(this.holder).top-window.pageYOffset-90>a:"bottom"!==this.direction&&this.isTopDirection(n,a);var l,c=i.top,u=[];t?(this.menuElement.classList.add("sc-menu__top"),this.inplace?(l=c+n,u.push("top: auto; bottom: "+Math.round(l)+"px;")):(c-=a,u.push("bottom: auto; top: "+Math.round(c)+"px;"))):(this.menuElement.classList.remove("sc-menu__top"),this.inplace||(c+=n),u.push("bottom: auto; top: "+Math.round(c)+"px;"));var h=Math.round(i.left-(o-s)),d=Math.round(i.left),f=Math.round(i.left+(s-o)/2);switch(r){case"left":u.push("left: "+h+"px;");break;case"right":u.push("left: "+d+"px;");break;case"auto":var m=e.firstByClass(this.menuElement,"entity-shortcut-menu_arw"),g=0,p=m?54:0,v=this.toRightFromHolder(i,o);if(v?(this.menuElement.classList.remove("__right"),this.menuElement.classList.add("__left")):(this.menuElement.classList.add("__right"),this.menuElement.classList.remove("__left")),!p&&(m=e.firstByClass(this.menuElement,"sc-menu_arw"))){var C=m.getBoundingClientRect();if(C.width){var y=this.menuElement.getBoundingClientRect();p=v?2*(C.left-y.left)+C.width:2*(y.left+y.width-(C.left+C.width))+C.width}}s<p&&(g=(p-s)/2),v?u.push("left: "+(d-g)+"px;"):u.push("left: "+(h+g)+"px;");break;default:u.push("left: "+f+"px;")}this.menuElement.setAttribute("style",u.join(""))},r.prototype.ajaxClose=function(e){this.ajaxRequest&&(this.ajaxRequest.xhr.abort(),this.ajaxRequest=null,this.cancelShow=!1,"function"==typeof e&&e())},r.prototype.hoverInListener=function(e){(OK.device.isTouch||Date.now()-this.activateTime<=this.ignoreHoverTime)&&e||(s!==this&&(s&&s.hide(),r.setActiveInstance(this)),this.clearHideTimeout(),this.showTimeout||this.visible()||(this.showTimeout=setTimeout(this.showMenu.bind(this),this.showDelay)))},r.prototype.hoverOutListener=function(){this.clearShowTimeout(),this.ajaxClose(),!this.hideTimeout&&this.visible()&&(this.hideTimeout=setTimeout(function(){this.hideOnBlurElement!==document.activeElement?this.hideMenu():this.hideTimeout=null}.bind(this),this.hideDelay))},r.prototype.menuElementHoverInListener=function(){this.menuElementHoverInListenerCalled=!0,this.hideTimeout&&(this.hideTimeout=clearTimeout(this.hideTimeout))},r.prototype.menuElementLinkClickListener=function(t){e.parent(t.target,"js-doNotHide",this.block)||this.menuElementClickListener()},r.prototype.menuElementClickListener=function(){!0===this.hideTimeout&&(this.hideTimeout=null),this.hoverOutListener()},r.prototype.holderTouchStartListener=function(e){e.stopPropagation()},r.prototype.clearShowTimeout=function(){this.showTimeout&&(this.showTimeout=clearTimeout(this.showTimeout))},r.prototype.clearHideTimeout=function(){this.hideTimeout&&(this.hideTimeout=clearTimeout(this.hideTimeout))},r.prototype.removeOneTimeListener=function(e){e&&(e.element.removeEventListener(e.type,e.handler),e=null)},r})),define("OK/discussions/CommentFormAuthorMenu",["OK/utils/dom","OK/AbstractShortcutMenu"],(function(e,t){"use strict";function n(){}return n.prototype={activate:function(n){var i=this;if(i.container=n,i.compId=n.getAttribute("data-compId"),i.author=document.getElementById(i.compId),i.authorAvatar=e.firstByClass(i.author,"js-comments_author-avatar"),i.authorName=e.firstByClass(i.author,"js-comments_author-name"),i.author&&(i.commentsForm=e.parent(i.author,"js-comments_form")),i.commentsForm){i.clickHandler=function(n){return function(n,i){var s=e.parent(i.target,"js-comments_authormenu-card"),o=e.firstByClass(s,"js-comments_authormenu-avatar");if(!s||!o)return;n.commentsForm.setAttribute("data-author-groupId",s.getAttribute("data-groupId")),n.commentsForm.setAttribute("data-author-json",s.getAttribute("data-json")),n.authorAvatar&&(n.authorAvatar.innerHTML=o.innerHTML);n.authorName&&(n.authorName.innerHTML=s.getAttribute("data-name"));e.byClass(n.container,"js-comments_authormenu-card").forEach((function(e){e.classList.remove("__selected")})),s.classList.add("__selected");var r=t.getActiveInstance();r&&r.hide(),i.stopPropagation()}(i,n)},i.container.addEventListener("click",i.clickHandler);var s=e.firstByClass(i.commentsForm,"iblock-cloud");s&&s.classList.remove("__active");for(var o=i.commentsForm.getAttribute("data-author-groupId"),r=e.byClass(i.container,"js-comments_authormenu-card"),a=0;a<r.length;a++){var l=r[a].getAttribute("data-groupId");if(!l&&!o||o==l){r[a].classList.add("__selected");break}}}},deactivate:function(){var e=this;e.container&&e.clickHandler&&e.container.addEventListener("click",e.clickHandler)}},n})),define("OK/discussions/Reveal",["OK/utils/dom"],(function(e){return{expand:function(t){e.firstByClass(t,"comments_text").classList.remove("__reveal-2","__reveal-3"),e.firstByClass(t,"comments_text_more").classList.add("invisible")},activate:function(t){var n=e.firstByClass(t,"comments_text");if(n){var i=parseInt(n.getAttribute("data-max-lines"),10);if(!isNaN(i)){var s=e.firstByClass(t,"comments_text_more"),o=parseInt(window.getComputedStyle(n)["line-height"],10)||21;n.firstChild.clientHeight/o>i+1?s.classList.remove("invisible"):n.classList.remove("__reveal-2","__reveal-3")}}}}})),define("OK/discussions/Mentions",[],(function(){"use strict";function e(e,t){this.element=t,this.textarea=document.getElementById(t.getAttribute("data-bind"))}function t(){this.hasFocus&&(this.selection=function(){var e=window.getSelection(),t=[];if(e.rangeCount)for(var n=0,i=e.rangeCount;n<i;++n)t.push(e.getRangeAt(n));return t}())}function n(){this.hasFocus=!1}function i(){this.hasFocus=!0}function s(){var e=this,t=window.getSelection();if(this.selection)!function(e){var t=window.getSelection();t.removeAllRanges();for(var n=0,i=e.length;n<i;++n)t.addRange(e[n])}(this.selection);else{var n=document.createRange();n.selectNodeContents(this.textarea),n.collapse(!0),this.selection=[n],t.removeAllRanges(),t.addRange(n)}if(t.getRangeAt&&t.rangeCount){var i=t.anchorNode&&t.anchorNode.nodeType===Node.TEXT_NODE&&/\s+$/.test(t.anchorNode.textContent),s=document.createTextNode(" "),o=document.createTextNode("@"),r=t.getRangeAt(0);r.deleteContents(),r.insertNode(o),0===t.anchorOffset||i||r.insertNode(s),setTimeout((function(){r.setStart(o,1),r.collapse(!0),t.removeAllRanges(),t.addRange(r),e.textarea.focus();var n=document.createEvent("Event");n.initEvent("keyup",!0,!0),e.textarea.dispatchEvent(n)}),10)}}return e.prototype={activate:function(){this.textarea.addEventListener("focus",this.focusListener=i.bind(this)),this.textarea.addEventListener("change",this.textareaListener=t.bind(this)),this.textarea.addEventListener("mouseup",this.textareaListener),this.textarea.addEventListener("keyup",this.textareaListener),this.textarea.addEventListener("blur",this.blurListener=n.bind(this)),this.element.addEventListener("click",this.clickListener=s.bind(this))},deactivate:function(){this.element.removeEventListener("click",this.clickListener),this.textarea.removeEventListener("focus",this.focusListener),this.textarea.removeEventListener("blur",this.blurListener),this.textarea.removeEventListener("change",this.textareaListener),this.textarea.removeEventListener("mouseup",this.textareaListener),this.textarea.removeEventListener("keyup",this.textareaListener)}},e})),define("b/discussions",["require","OK/Discussion","OK/DiscussionManager","OK/discussions/ScrollController","OK/discussions/Comment","OK/discussions/CommentEntry","OK/discussions/CommentsList","OK/discussions/CommentForm","OK/discussions/CommentFormAuthorMenu","OK/discussions/LinkAttachController","OK/discussions/TypingStatus","OK/utils/textchange","OK/discussions/Reveal","OK/discussions/Mentions"],(function(require){"use strict";return require("OK/Discussion"),require("OK/DiscussionManager"),require("OK/discussions/ScrollController"),require("OK/discussions/Comment"),require("OK/discussions/CommentEntry"),require("OK/discussions/CommentsList"),require("OK/discussions/CommentForm"),require("OK/discussions/CommentFormAuthorMenu"),require("OK/discussions/LinkAttachController"),require("OK/discussions/TypingStatus"),require("OK/utils/textchange"),require("OK/discussions/Reveal"),require("OK/discussions/Mentions"),function(){}}));
//# sourceMappingURL=/res/source-maps/js/b/discussions.js.map